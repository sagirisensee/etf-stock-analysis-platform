<!DOCTYPE html>
<html>
<head>
    <title>è¯Šæ–­é¡µé¢</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>ğŸ” ç³»ç»Ÿè¯Šæ–­é¡µé¢</h1>

    <div class="section">
        <h2>1. é¡µé¢åŠ è½½çŠ¶æ€</h2>
        <div id="pageStatus">æ­£åœ¨æ£€æŸ¥...</div>
    </div>

    <div class="section">
        <h2>2. APIè¿æ¥æµ‹è¯•</h2>
        <button onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
        <div id="connectionStatus"></div>
    </div>

    <div class="section">
        <h2>3. ç™»å½•çŠ¶æ€æ£€æŸ¥</h2>
        <button onclick="checkLogin()">æ£€æŸ¥ç™»å½•</button>
        <div id="loginStatus"></div>
    </div>

    <div class="section">
        <h2>4. æ± å­æ•°æ®è·å–</h2>
        <button onclick="getPools()">è·å–æ± å­æ•°æ®</button>
        <div id="poolsStatus"></div>
    </div>

    <div class="section">
        <h2>5. æµè§ˆå™¨ä¿¡æ¯</h2>
        <pre id="browserInfo"></pre>
    </div>

    <script>
        // é¡µé¢åŠ è½½çŠ¶æ€
        window.addEventListener('load', function() {
            document.getElementById('pageStatus').innerHTML =
                '<div class="success">âœ… é¡µé¢åŠ è½½æˆåŠŸ</div>';
            showBrowserInfo();
        });

        // æµ‹è¯•è¿æ¥
        async function testConnection() {
            const status = document.getElementById('connectionStatus');
            try {
                status.innerHTML = 'æ­£åœ¨æµ‹è¯•è¿æ¥...';
                const response = await fetch('/api/check-login', {
                    method: 'GET',
                    credentials: 'same-origin'
                });

                if (response.status === 302) {
                    status.innerHTML = '<div class="error">âŒ æœªç™»å½•ï¼Œéœ€è¦ç™»å½•</div>';
                } else if (response.status === 200) {
                    const data = await response.json();
                    status.innerHTML = '<div class="success">âœ… è¿æ¥æˆåŠŸï¼š' + JSON.stringify(data) + '</div>';
                } else {
                    status.innerHTML = '<div class="error">âŒ çŠ¶æ€ç ï¼š' + response.status + '</div>';
                }
            } catch (error) {
                status.innerHTML = '<div class="error">âŒ è¿æ¥å¤±è´¥ï¼š' + error.message + '</div>';
            }
        }

        // æ£€æŸ¥ç™»å½•
        async function checkLogin() {
            const status = document.getElementById('loginStatus');
            try {
                status.innerHTML = 'æ­£åœ¨æ£€æŸ¥ç™»å½•çŠ¶æ€...';
                const response = await fetch('/api/check-login', {
                    method: 'GET',
                    credentials: 'same-origin'
                });

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    status.innerHTML = '<div class="error">âŒ æœªç™»å½•æˆ–ä¼šè¯è¿‡æœŸ</div>';
                    return;
                }

                const data = await response.json();
                if (data.success) {
                    status.innerHTML = '<div class="success">âœ… å·²ç™»å½• - ç”¨æˆ·IDï¼š' + data.user_id + ', ç”¨æˆ·åï¼š' + data.username + '</div>';
                } else {
                    status.innerHTML = '<div class="error">âŒ ç™»å½•æ£€æŸ¥å¤±è´¥</div>';
                }
            } catch (error) {
                status.innerHTML = '<div class="error">âŒ æ£€æŸ¥å¤±è´¥ï¼š' + error.message + '</div>';
            }
        }

        // è·å–æ± å­æ•°æ®
        async function getPools() {
            const status = document.getElementById('poolsStatus');
            try {
                status.innerHTML = 'æ­£åœ¨è·å–æ± å­æ•°æ®...';
                const response = await fetch('/api/pools', {
                    method: 'GET',
                    credentials: 'same-origin'
                });

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    status.innerHTML = '<div class="error">âŒ æœªç™»å½•æˆ–APIè¿”å›éJSONæ•°æ®</div>';
                    return;
                }

                const data = await response.json();
                if (data.success) {
                    const etfCount = data.etf_pools ? data.etf_pools.length : 0;
                    const stockCount = data.stock_pools ? data.stock_pools.length : 0;
                    let details = 'ETFæ•°é‡ï¼š' + etfCount + 'ï¼Œè‚¡ç¥¨æ•°é‡ï¼š' + stockCount + '<br>';

                    if (etfCount > 0) {
                        details += '<strong>ETFï¼š</strong><br>';
                        data.etf_pools.slice(0, 3).forEach(pool => {
                            details += '  - ' + pool.name + ' (' + pool.code + ')<br>';
                        });
                        if (etfCount > 3) details += '  ... è¿˜æœ‰ ' + (etfCount - 3) + ' ä¸ª<br>';
                    }

                    if (stockCount > 0) {
                        details += '<strong>è‚¡ç¥¨ï¼š</strong><br>';
                        data.stock_pools.slice(0, 3).forEach(pool => {
                            details += '  - ' + pool.name + ' (' + pool.code + ')<br>';
                        });
                    }

                    status.innerHTML = '<div class="success">âœ… è·å–æˆåŠŸ<br>' + details + '</div>';
                } else {
                    status.innerHTML = '<div class="error">âŒ APIè¿”å›é”™è¯¯ï¼š' + data.error + '</div>';
                }
            } catch (error) {
                status.innerHTML = '<div class="error">âŒ è·å–å¤±è´¥ï¼š' + error.message + '</div>';
            }
        }

        // æ˜¾ç¤ºæµè§ˆå™¨ä¿¡æ¯
        function showBrowserInfo() {
            const info = {
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine
            };
            document.getElementById('browserInfo').textContent = JSON.stringify(info, null, 2);
        }

        // è‡ªåŠ¨è¿è¡Œé¡µé¢åŠ è½½æ£€æŸ¥
        window.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const pageStatus = document.getElementById('pageStatus');
                if (pageStatus.innerHTML === 'æ­£åœ¨æ£€æŸ¥...') {
                    pageStatus.innerHTML = '<div class="error">âŒ é¡µé¢åŠ è½½å¼‚å¸¸</div>';
                }
            }, 1000);
        });
    </script>
</body>
</html>