{% extends "base.html" %}

{% block title %}ç³»ç»Ÿé…ç½® - AIé‡åŒ–æŠ•èµ„åˆ†æå¹³å°{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-cog me-2"></i>ç³»ç»Ÿé…ç½®
                </h4>
                <p class="text-muted mb-0 mt-2">é…ç½®AIæ¨¡å‹å’Œç³»ç»Ÿå‚æ•°ä»¥å¼€å§‹ä½¿ç”¨åˆ†æåŠŸèƒ½</p>
            </div>
            <div class="card-body">
                <form method="POST" id="configForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="LLM_API_BASE" class="form-label">
                                    <i class="fas fa-server me-1"></i>AIæ¨¡å‹APIåŸºç¡€URL
                                </label>
                                <input type="url" class="form-control" id="LLM_API_BASE" name="LLM_API_BASE" 
                                       value="{{ configs.LLM_API_BASE }}" 
                                       placeholder="è¯·è¾“å…¥æ‚¨çš„APIåŸºç¡€URL"
                                       required>
                                <div class="form-text">
                                    æ”¯æŒOpenAIå…¼å®¹çš„APIæœåŠ¡ï¼Œå¦‚Perplexity AIã€OpenAIç­‰
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="LLM_API_KEY" class="form-label">
                                    <i class="fas fa-key me-1"></i>AIæ¨¡å‹APIå¯†é’¥
                                </label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="LLM_API_KEY" name="LLM_API_KEY" 
                                           value="{{ configs.LLM_API_KEY }}" 
                                           placeholder="è¾“å…¥æ‚¨çš„APIå¯†é’¥"
                                           required>
                                    <button class="btn btn-outline-secondary" type="button" id="toggleApiKey">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <div class="form-text">
                                    è¯·ç¡®ä¿APIå¯†é’¥æœ‰è¶³å¤Ÿçš„è°ƒç”¨é¢åº¦
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="LLM_MODEL_NAME" class="form-label">
                                    <i class="fas fa-brain me-1"></i>AIæ¨¡å‹åç§°
                                </label>
                                <select class="form-select" id="LLM_MODEL_NAME" name="LLM_MODEL_NAME" required>
                                    <option value="" {{ 'selected' if not configs.LLM_MODEL_NAME or configs.LLM_MODEL_NAME == '' }}>è¯·é€‰æ‹©æ¨¡å‹</option>
                                    <optgroup label="å¸¸ç”¨æ¨¡å‹">
                                        <option value="sonar-pro" {{ 'selected' if configs.LLM_MODEL_NAME == 'sonar-pro' }}>Perplexity Sonar Pro</option>
                                        <option value="gpt-4" {{ 'selected' if configs.LLM_MODEL_NAME == 'gpt-4' }}>OpenAI GPT-4</option>
                                        <option value="gpt-3.5-turbo" {{ 'selected' if configs.LLM_MODEL_NAME == 'gpt-3.5-turbo' }}>OpenAI GPT-3.5 Turbo</option>
                                        <option value="Qwen/Qwen3-8B" {{ 'selected' if configs.LLM_MODEL_NAME == 'Qwen/Qwen3-8B' }}>ç¡…åŸºæµåŠ¨ Qwen3-8B (å…è´¹)</option>
                                    </optgroup>
                                    <optgroup label="Perplexity AI">
                                        <option value="sonar-medium" {{ 'selected' if configs.LLM_MODEL_NAME == 'sonar-medium' }}>Sonar Medium</option>
                                        <option value="sonar-small" {{ 'selected' if configs.LLM_MODEL_NAME == 'sonar-small' }}>Sonar Small</option>
                                        <option value="llama-3.1-sonar-large-128k-chat" {{ 'selected' if configs.LLM_MODEL_NAME == 'llama-3.1-sonar-large-128k-chat' }}>Llama 3.1 Sonar Large (128k)</option>
                                        <option value="llama-3.1-sonar-small-128k-chat" {{ 'selected' if configs.LLM_MODEL_NAME == 'llama-3.1-sonar-small-128k-chat' }}>Llama 3.1 Sonar Small (128k)</option>
                                    </optgroup>
                                    <optgroup label="å…¶ä»–æœåŠ¡">
                                        <option value="claude-3-sonnet" {{ 'selected' if configs.LLM_MODEL_NAME == 'claude-3-sonnet' }}>Claude 3 Sonnet</option>
                                    </optgroup>
                                    <option value="custom" {{ 'selected' if configs.LLM_MODEL_NAME and configs.LLM_MODEL_NAME not in ['Qwen/Qwen3-8B', 'sonar-pro', 'sonar-medium', 'sonar-small', 'llama-3.1-sonar-large-128k-chat', 'llama-3.1-sonar-small-128k-chat', 'gpt-4', 'gpt-3.5-turbo', 'claude-3-sonnet'] }}>è‡ªå®šä¹‰æ¨¡å‹</option>
                                </select>
                                <div class="form-text">
                                    é€‰æ‹©æ‚¨è¦ä½¿ç”¨çš„AIæ¨¡å‹
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="CACHE_EXPIRE_SECONDS" class="form-label">
                                    <i class="fas fa-clock me-1"></i>æ•°æ®ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰
                                </label>
                                <input type="number" class="form-control" id="CACHE_EXPIRE_SECONDS" name="CACHE_EXPIRE_SECONDS" 
                                       value="{{ configs.CACHE_EXPIRE_SECONDS }}" 
                                       min="30" max="3600" 
                                       placeholder="60">
                                <div class="form-text">
                                    å¸‚åœºæ•°æ®ç¼“å­˜æœ‰æ•ˆæœŸï¼Œå»ºè®®30-300ç§’
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è‡ªå®šä¹‰æ¨¡å‹åç§°è¾“å…¥æ¡† -->
                    <div class="row" id="customModelRow" style="display: {{ 'block' if configs.LLM_MODEL_NAME and configs.LLM_MODEL_NAME not in ['Qwen/Qwen3-8B', 'sonar-pro', 'gpt-4', 'gpt-3.5-turbo', 'claude-3-sonnet'] else 'none' }};">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="customModelName" class="form-label">
                                    <i class="fas fa-edit me-1"></i>è‡ªå®šä¹‰æ¨¡å‹åç§°
                                </label>
                                <input type="text" class="form-control" id="customModelName" name="customModelName"
                                       value="{{ configs.LLM_MODEL_NAME if configs.LLM_MODEL_NAME and configs.LLM_MODEL_NAME not in ['Qwen/Qwen3-8B', 'sonar-pro', 'gpt-4', 'gpt-3.5-turbo', 'claude-3-sonnet'] else '' }}"
                                       placeholder="è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹åç§°">
                                <div class="form-text">
                                    è¾“å…¥æ‚¨çš„è‡ªå®šä¹‰AIæ¨¡å‹åç§°
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary" id="testConnection">
                                    <i class="fas fa-plug me-1"></i>æµ‹è¯•è¿æ¥
                                </button>
                                <div>
                            <!-- è°ƒè¯•ä¿¡æ¯æŒ‰é’®å·²æ³¨é‡Š
                            <button type="button" class="btn btn-outline-info me-2" id="debugConfig">
                                <i class="fas fa-bug me-1"></i>è°ƒè¯•ä¿¡æ¯
                            </button>
                            -->
                                    <button type="button" class="btn btn-outline-secondary me-2" onclick="resetForm()">
                                        <i class="fas fa-undo me-1"></i>é‡ç½®
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-1"></i>ä¿å­˜é…ç½®
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- é…ç½®è¯´æ˜å¡ç‰‡ -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>é…ç½®è¯´æ˜
                </h5>
            </div>
            <div class="card-body">
                <h6><i class="fas fa-server text-primary me-2"></i>APIåŸºç¡€URL</h6>
                <p class="small text-muted mb-3">
                    æ”¯æŒOpenAIå…¼å®¹çš„APIæœåŠ¡ã€‚æ¨èæœåŠ¡ï¼š
                </p>
                <ul class="small">
                    <li><strong>ç¡…åŸºæµåŠ¨:</strong> https://api.siliconflow.cn/v1</li>
                    <li><strong>Perplexity AI:</strong> https://api.perplexity.ai</li>
                    <li><strong>OpenAI:</strong> https://api.openai.com/v1</li>
                    <li><strong>å…¶ä»–å…¼å®¹æœåŠ¡:</strong> è¯·å‚è€ƒæœåŠ¡å•†æ–‡æ¡£</li>
                </ul>
                
                <h6 class="mt-3"><i class="fas fa-key text-warning me-2"></i>APIå¯†é’¥</h6>
                <p class="small text-muted">
                    ä»æ‚¨é€‰æ‹©çš„AIæœåŠ¡å•†è·å–APIå¯†é’¥ã€‚è¯·ç¡®ä¿å¯†é’¥æœ‰è¶³å¤Ÿçš„è°ƒç”¨é¢åº¦ï¼Œ
                    å› ä¸ºæ¯æ¬¡åˆ†æä¼šè°ƒç”¨å¤šæ¬¡AIæ¥å£ã€‚
                </p>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>ä½¿ç”¨å»ºè®®
                </h5>
            </div>
            <div class="card-body">
                <h6><i class="fas fa-brain text-success me-2"></i>æ¨¡å‹é€‰æ‹©</h6>
                <ul class="small">
                    <li><strong>Qwen3-8B:</strong> å…è´¹æ¨èï¼Œåˆ†æè´¨é‡ä¼˜ç§€ï¼Œé€‚åˆæ–°æ‰‹</li>
                    <li><strong>Sonar Pro:</strong> æ€§ä»·æ¯”é«˜ï¼Œåˆ†æè´¨é‡å¥½</li>
                    <li><strong>GPT-4:</strong> åˆ†æè´¨é‡æœ€é«˜ï¼Œä½†æˆæœ¬è¾ƒé«˜</li>
                    <li><strong>GPT-3.5:</strong> æˆæœ¬ä½ï¼Œé€‚åˆå¤§é‡åˆ†æ</li>
                </ul>
                
                <h6 class="mt-3"><i class="fas fa-clock text-info me-2"></i>ç¼“å­˜è®¾ç½®</h6>
                <p class="small text-muted">
                    è¾ƒçŸ­çš„ç¼“å­˜æ—¶é—´å¯è·å–æ›´æ–°çš„æ•°æ®ï¼Œä½†ä¼šå¢åŠ APIè°ƒç”¨æ¬¡æ•°ã€‚
                    å»ºè®®åœ¨äº¤æ˜“æ—¶é—´å†…ä½¿ç”¨60-120ç§’ç¼“å­˜ã€‚
                </p>
                
                <div class="alert alert-warning small mt-3">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    <strong>æ³¨æ„ï¼š</strong>è¯·å¦¥å–„ä¿ç®¡æ‚¨çš„APIå¯†é’¥ï¼Œä¸è¦åˆ†äº«ç»™ä»–äººã€‚
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // åˆ‡æ¢APIå¯†é’¥æ˜¾ç¤º/éšè—
    document.getElementById('toggleApiKey').addEventListener('click', function() {
        const apiKeyInput = document.getElementById('LLM_API_KEY');
        const icon = this.querySelector('i');
        
        if (apiKeyInput.type === 'password') {
            apiKeyInput.type = 'text';
            icon.className = 'fas fa-eye-slash';
        } else {
            apiKeyInput.type = 'password';
            icon.className = 'fas fa-eye';
        }
    });

    // æ¨¡å‹é€‰æ‹©å˜åŒ–å¤„ç†
    document.getElementById('LLM_MODEL_NAME').addEventListener('change', function() {
        const customModelRow = document.getElementById('customModelRow');
        const customModelInput = document.getElementById('customModelName');
        
        if (this.value === 'custom') {
            customModelRow.style.display = 'block';
            customModelInput.required = true;
        } else {
            customModelRow.style.display = 'none';
            customModelInput.required = false;
        }
    });

    // è¡¨å•æäº¤å¤„ç†
    document.getElementById('configForm').addEventListener('submit', async function(e) {
        const modelSelect = document.getElementById('LLM_MODEL_NAME');
        const customModelInput = document.getElementById('customModelName');
        
        console.log('è¡¨å•æäº¤ - æ¨¡å‹é€‰æ‹©æ¡†å€¼:', modelSelect.value);
        console.log('è¡¨å•æäº¤ - è‡ªå®šä¹‰æ¨¡å‹è¾“å…¥æ¡†å€¼:', customModelInput.value);
        
        // å¦‚æœé€‰æ‹©äº†è‡ªå®šä¹‰æ¨¡å‹ï¼Œæ·»åŠ ä¸€ä¸ªéšè—å­—æ®µæ¥ä¼ é€’è‡ªå®šä¹‰æ¨¡å‹åç§°
        if (modelSelect.value === 'custom' && customModelInput.value.trim()) {
            console.log('æ£€æµ‹åˆ°è‡ªå®šä¹‰æ¨¡å‹ï¼Œæ·»åŠ éšè—å­—æ®µä¼ é€’è‡ªå®šä¹‰æ¨¡å‹åç§°:', customModelInput.value.trim());
            
            // ç§»é™¤ä¹‹å‰çš„éšè—å­—æ®µï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const existingHidden = document.getElementById('customModelNameHidden');
            if (existingHidden) {
                existingHidden.remove();
            }
            
            // æ·»åŠ éšè—å­—æ®µä¼ é€’è‡ªå®šä¹‰æ¨¡å‹åç§°
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.id = 'customModelNameHidden';
            hiddenInput.name = 'LLM_MODEL_NAME';
            hiddenInput.value = customModelInput.value.trim();
            modelSelect.parentNode.appendChild(hiddenInput);
            
            // å°†æ¨¡å‹é€‰æ‹©æ¡†çš„å€¼æ”¹å› 'custom'ï¼Œä¿æŒé¡µé¢çŠ¶æ€
            modelSelect.value = 'custom';
        }
        
        // ç­‰å¾…è¡¨å•æäº¤å®Œæˆ
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // æ¸…é™¤æµ‹è¯•é…ç½®
        try {
            await fetch('/api/clear-test-config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            console.log('æµ‹è¯•é…ç½®å·²æ¸…é™¤');
        } catch (error) {
            console.error('æ¸…é™¤æµ‹è¯•é…ç½®å¤±è´¥:', error);
        }
    });

    // æ¢å¤åˆ°æµ‹è¯•å‰çŠ¶æ€çš„å‡½æ•°
    function restoreFormToOriginalState(originalState) {
        try {
            // æ¢å¤è¡¨å•å­—æ®µ
            document.getElementById('LLM_API_BASE').value = originalState.apiBase || '';
            document.getElementById('LLM_API_KEY').value = originalState.apiKey || '';
            
            // å¤„ç†æ¨¡å‹é€‰æ‹©
            if (originalState.selectedModel === 'custom') {
                // è‡ªå®šä¹‰æ¨¡å‹
                document.getElementById('LLM_MODEL_NAME').value = 'custom';
                document.getElementById('customModelName').value = originalState.customModelName || '';
                document.getElementById('customModelRow').style.display = 'block';
            } else {
                // é¢„å®šä¹‰æ¨¡å‹
                document.getElementById('LLM_MODEL_NAME').value = originalState.selectedModel || '';
                document.getElementById('customModelName').value = '';
                document.getElementById('customModelRow').style.display = 'none';
            }
            
            console.log('è¡¨å•å·²æ¢å¤åˆ°æµ‹è¯•å‰çŠ¶æ€:', originalState);
        } catch (error) {
            console.error('æ¢å¤è¡¨å•çŠ¶æ€å¤±è´¥:', error);
        }
    }

    // ä»æ•°æ®åº“æ¢å¤è¡¨å•çŠ¶æ€çš„å‡½æ•°
    async function restoreFormFromDatabase() {
        try {
            // è·å–æ•°æ®åº“ä¸­çš„é…ç½®
            const response = await fetch('/api/config');
            const data = await response.json();
            
            if (data.success) {
                const configs = data.configs;
                
                // æ¢å¤è¡¨å•å­—æ®µ
                document.getElementById('LLM_API_BASE').value = configs.LLM_API_BASE || '';
                document.getElementById('LLM_API_KEY').value = configs.LLM_API_KEY || '';
                document.getElementById('CACHE_EXPIRE_SECONDS').value = configs.CACHE_EXPIRE_SECONDS || '60';
                
                // å¤„ç†æ¨¡å‹åç§°
                const modelName = configs.LLM_MODEL_NAME || '';
                const predefinedModels = ['Qwen/Qwen3-8B', 'sonar-pro', 'sonar-medium', 'sonar-small', 'llama-3.1-sonar-large-128k-chat', 'llama-3.1-sonar-small-128k-chat', 'gpt-4', 'gpt-3.5-turbo', 'claude-3-sonnet'];
                
                if (predefinedModels.includes(modelName)) {
                    // é¢„å®šä¹‰æ¨¡å‹
                    document.getElementById('LLM_MODEL_NAME').value = modelName;
                    document.getElementById('customModelName').value = '';
                    document.getElementById('customModelRow').style.display = 'none';
                } else if (modelName) {
                    // è‡ªå®šä¹‰æ¨¡å‹
                    document.getElementById('LLM_MODEL_NAME').value = 'custom';
                    document.getElementById('customModelName').value = modelName;
                    document.getElementById('customModelRow').style.display = 'block';
                } else {
                    // ç©ºå€¼
                    document.getElementById('LLM_MODEL_NAME').value = '';
                    document.getElementById('customModelName').value = '';
                    document.getElementById('customModelRow').style.display = 'none';
                }
                
                console.log('è¡¨å•å·²æ¢å¤åˆ°æ•°æ®åº“çŠ¶æ€:', configs);
            }
        } catch (error) {
            console.error('æ¢å¤è¡¨å•çŠ¶æ€å¤±è´¥:', error);
        }
    }

    // é¡µé¢åŠ è½½æ—¶ç¡®ä¿è¡¨å•çŠ¶æ€æ­£ç¡®
    document.addEventListener('DOMContentLoaded', function() {
        // é¡µé¢åŠ è½½å®Œæˆåï¼Œç¡®ä¿è¡¨å•çŠ¶æ€ä¸æ•°æ®åº“ä¸€è‡´
        console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œè¡¨å•çŠ¶æ€å·²åˆå§‹åŒ–');
    });

    // è°ƒè¯•ä¿¡æ¯åŠŸèƒ½å·²æ³¨é‡Š
    /*
    document.getElementById('debugConfig').addEventListener('click', async function() {
        const modelSelect = document.getElementById('LLM_MODEL_NAME');
        const customModelInput = document.getElementById('customModelName');
        const customModelRow = document.getElementById('customModelRow');
        
        // å‰ç«¯è°ƒè¯•ä¿¡æ¯
        const frontendDebugInfo = {
            'æ¨¡å‹é€‰æ‹©æ¡†å€¼': modelSelect.value,
            'æ¨¡å‹é€‰æ‹©æ¡†æ˜¾ç¤ºæ–‡æœ¬': modelSelect.options[modelSelect.selectedIndex]?.text || 'æ— ',
            'è‡ªå®šä¹‰æ¨¡å‹è¾“å…¥æ¡†å€¼': customModelInput.value,
            'è‡ªå®šä¹‰æ¨¡å‹è¡Œæ˜¾ç¤ºçŠ¶æ€': customModelRow.style.display,
            'è‡ªå®šä¹‰æ¨¡å‹è¡Œæ˜¯å¦å¯è§': customModelRow.offsetParent !== null,
            'å½“å‰æ—¶é—´': new Date().toLocaleString()
        };
        
        // è·å–åç«¯çœŸå®é…ç½®ä¿¡æ¯
        try {
            const response = await fetch('/api/debug-config');
            const data = await response.json();
            
            if (data.success) {
                const backendDebugInfo = {
                    'æ•°æ®åº“ä¸­çš„æ¨¡å‹åç§°': data.database_config.LLM_MODEL_NAME || 'æœªè®¾ç½®',
                    'ç¯å¢ƒå˜é‡ä¸­çš„æ¨¡å‹åç§°': data.environment_config.LLM_MODEL_NAME || 'æœªè®¾ç½®',
                    'çœŸå®ä½¿ç”¨çš„æ¨¡å‹åç§°': data.real_model_name || 'æœªè®¾ç½®',
                    'APIåŸºç¡€URL': data.database_config.LLM_API_BASE || 'æœªè®¾ç½®',
                    'APIå¯†é’¥çŠ¶æ€': data.database_config.LLM_API_KEY ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®',
                    'ç¼“å­˜è¿‡æœŸæ—¶é—´': data.database_config.CACHE_EXPIRE_SECONDS + 'ç§’'
                };
                
                // åˆå¹¶è°ƒè¯•ä¿¡æ¯
                const allDebugInfo = {
                    ...frontendDebugInfo,
                    '--- åç«¯çœŸå®é…ç½® ---': '---',
                    ...backendDebugInfo
                };
                
                let debugText = 'ğŸ” å®Œæ•´è°ƒè¯•ä¿¡æ¯ï¼š\n\n';
                for (const [key, value] of Object.entries(allDebugInfo)) {
                    if (key === '--- åç«¯çœŸå®é…ç½® ---') {
                        debugText += `\n${key}\n`;
                    } else {
                        debugText += `${key}: ${value}\n`;
                    }
                }
                
                // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
                alert(debugText);
                
                // åŒæ—¶åœ¨æ§åˆ¶å°è¾“å‡º
                console.log('=== å®Œæ•´è°ƒè¯•ä¿¡æ¯ ===');
                console.log(allDebugInfo);
            } else {
                throw new Error(data.error || 'è·å–åç«¯é…ç½®å¤±è´¥');
            }
        } catch (error) {
            console.error('è·å–åç«¯é…ç½®å¤±è´¥:', error);
            
            // å¦‚æœåç«¯è¯·æ±‚å¤±è´¥ï¼Œåªæ˜¾ç¤ºå‰ç«¯ä¿¡æ¯
            let debugText = 'ğŸ” å‰ç«¯è°ƒè¯•ä¿¡æ¯ï¼š\n\n';
            for (const [key, value] of Object.entries(frontendDebugInfo)) {
                debugText += `${key}: ${value}\n`;
            }
            debugText += `\nâš ï¸ åç«¯é…ç½®è·å–å¤±è´¥: ${error.message}`;
            
            alert(debugText);
        }
    });
    */

    // æµ‹è¯•è¿æ¥åŠŸèƒ½
    document.getElementById('testConnection').addEventListener('click', async function() {
        const button = this;
        const originalText = button.innerHTML;
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>æµ‹è¯•ä¸­...';
        button.disabled = true;
        
        try {
            const apiBase = document.getElementById('LLM_API_BASE').value;
            const apiKey = document.getElementById('LLM_API_KEY').value;
            const selectedModel = document.getElementById('LLM_MODEL_NAME').value;
            const customModelName = document.getElementById('customModelName').value;
            
            // å¦‚æœé€‰æ‹©çš„æ˜¯è‡ªå®šä¹‰æ¨¡å‹ï¼Œä½¿ç”¨è‡ªå®šä¹‰æ¨¡å‹åç§°
            const modelName = selectedModel === 'custom' ? customModelName : selectedModel;
            
            if (!apiBase || !apiKey || !modelName) {
                showAlert('è¯·å…ˆå¡«å†™å®Œæ•´çš„é…ç½®ä¿¡æ¯', 'warning');
                return;
            }
            
            // å¦‚æœé€‰æ‹©è‡ªå®šä¹‰æ¨¡å‹ä½†æ²¡æœ‰å¡«å†™è‡ªå®šä¹‰æ¨¡å‹åç§°
            if (selectedModel === 'custom' && !customModelName) {
                showAlert('è¯·å¡«å†™è‡ªå®šä¹‰æ¨¡å‹åç§°', 'warning');
                return;
            }
            
            // å…ˆä¿å­˜æµ‹è¯•é…ç½®åˆ°ä¸´æ—¶å­˜å‚¨
            const testConfigData = {
                LLM_API_BASE: apiBase,
                LLM_API_KEY: apiKey,
                LLM_MODEL_NAME: modelName,
                CACHE_EXPIRE_SECONDS: document.getElementById('CACHE_EXPIRE_SECONDS').value
            };
            
            // ä¿å­˜æµ‹è¯•é…ç½®
            const testConfigResponse = await fetch('/api/test-config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(testConfigData)
            });
            
            if (!testConfigResponse.ok) {
                throw new Error('ä¿å­˜æµ‹è¯•é…ç½®å¤±è´¥');
            }
            
            // ç„¶åè¿›è¡Œè¿æ¥æµ‹è¯•
            const response = await fetch('/api/test-connection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const data = await response.json();
            
            if (!data.success) {
                // æµ‹è¯•å¤±è´¥ï¼Œä»æ•°æ®åº“æ¢å¤è¡¨å•çŠ¶æ€
                await restoreFormFromDatabase();
                throw new Error(data.error);
            }
            
            // æ˜¾ç¤ºæ›´æ˜¾çœ¼çš„æˆåŠŸæç¤º
            const successAlert = document.createElement('div');
            successAlert.className = 'alert alert-success alert-dismissible fade show position-fixed';
            successAlert.style.cssText = `
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                border: 2px solid #27ae60;
                background: linear-gradient(135deg, #27ae60, #2ecc71);
                color: white;
                font-weight: bold;
            `;
            successAlert.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-check-circle fa-2x me-3"></i>
                    <div>
                        <h6 class="mb-1">è¿æ¥æµ‹è¯•æˆåŠŸï¼</h6>
                        <small>AIæ¨¡å‹é…ç½®æœ‰æ•ˆï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨</small>
                        <br><small class="text-muted">å“åº”: ${data.response || 'æ— å“åº”'}</small>
                        <br><small class="text-warning">ğŸ’¡ è¯·ç‚¹å‡»"ä¿å­˜é…ç½®"æŒ‰é’®ä¿å­˜è®¾ç½®</small>
                    </div>
                    <button type="button" class="btn-close btn-close-white ms-3" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            document.body.appendChild(successAlert);
            
            // è‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                if (successAlert.parentNode) {
                    successAlert.remove();
                }
            }, 5000);
            
        } catch (error) {
            // æ˜¾ç¤ºæ›´æ˜¾çœ¼çš„å¤±è´¥æç¤º
            const errorAlert = document.createElement('div');
            errorAlert.className = 'alert alert-danger alert-dismissible fade show position-fixed';
            errorAlert.style.cssText = `
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                border: 2px solid #e74c3c;
                background: linear-gradient(135deg, #e74c3c, #ec7063);
                color: white;
                font-weight: bold;
            `;
            errorAlert.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                    <div>
                        <h6 class="mb-1">è¿æ¥æµ‹è¯•å¤±è´¥ï¼</h6>
                        <small>${error.message}</small>
                    </div>
                    <button type="button" class="btn-close btn-close-white ms-3" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            document.body.appendChild(errorAlert);
            
            // è‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                if (errorAlert.parentNode) {
                    errorAlert.remove();
                }
            }, 8000);
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            button.innerHTML = originalText;
            button.disabled = false;
        }
    });

    // é‡ç½®è¡¨å•
    function resetForm() {
        if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰é…ç½®å—ï¼Ÿ')) {
            document.getElementById('configForm').reset();
            document.getElementById('customModelRow').style.display = 'none';
        }
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è‡ªå®šä¹‰æ¨¡å‹
    document.addEventListener('DOMContentLoaded', function() {
        const modelSelect = document.getElementById('LLM_MODEL_NAME');
        const customModelRow = document.getElementById('customModelRow');
        const customModelInput = document.getElementById('customModelName');
        
        console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–æ¨¡å‹é€‰æ‹©æ¡†');
        console.log('å½“å‰æ¨¡å‹é€‰æ‹©æ¡†çš„å€¼:', modelSelect.value);
        
        // å¼ºåˆ¶æ£€æŸ¥å¹¶è®¾ç½®è‡ªå®šä¹‰æ¨¡å‹
        const presetModels = ['Qwen/Qwen3-8B', 'sonar-pro', 'gpt-4', 'gpt-3.5-turbo', 'claude-3-sonnet'];
        
        if (modelSelect.value === 'custom') {
            console.log('æ£€æµ‹åˆ°customé€‰é¡¹è¢«é€‰ä¸­ï¼Œæ˜¾ç¤ºè‡ªå®šä¹‰æ¨¡å‹è¡Œ');
            customModelRow.style.display = 'block';
            customModelInput.required = true;
            console.log('è®¾ç½®è‡ªå®šä¹‰æ¨¡å‹è¡Œæ˜¾ç¤ºçŠ¶æ€ä¸ºblock');
        } else if (modelSelect.value && !presetModels.includes(modelSelect.value)) {
            console.log('æ£€æµ‹åˆ°è‡ªå®šä¹‰æ¨¡å‹åç§°ï¼Œåˆ‡æ¢åˆ°è‡ªå®šä¹‰æ¨¡å¼');
            const originalModelName = modelSelect.value;
            modelSelect.value = 'custom';
            customModelInput.value = originalModelName;
            customModelRow.style.display = 'block';
            customModelInput.required = true;
            console.log('è‡ªå®šä¹‰æ¨¡å‹è®¾ç½®å®Œæˆï¼Œæ¨¡å‹åç§°:', originalModelName);
        } else {
            console.log('ä½¿ç”¨é¢„è®¾æ¨¡å‹æˆ–æœªé€‰æ‹©æ¨¡å‹');
            customModelRow.style.display = 'none';
            customModelInput.required = false;
        }
        
        // å¼ºåˆ¶æ£€æŸ¥ï¼šå¦‚æœè‡ªå®šä¹‰æ¨¡å‹è¾“å…¥æ¡†æœ‰å€¼ï¼Œç¡®ä¿æ˜¾ç¤ºè‡ªå®šä¹‰æ¨¡å‹è¡Œ
        if (customModelInput.value && customModelInput.value.trim()) {
            console.log('æ£€æµ‹åˆ°è‡ªå®šä¹‰æ¨¡å‹è¾“å…¥æ¡†æœ‰å€¼ï¼Œå¼ºåˆ¶æ˜¾ç¤ºè‡ªå®šä¹‰æ¨¡å‹è¡Œ');
            customModelRow.style.display = 'block';
            customModelInput.required = true;
            if (modelSelect.value !== 'custom') {
                modelSelect.value = 'custom';
                console.log('å¼ºåˆ¶è®¾ç½®é€‰æ‹©æ¡†ä¸ºcustom');
            }
        }
        
        // é¢å¤–å¼ºåˆ¶æ£€æŸ¥ï¼šå¦‚æœé€‰æ‹©æ¡†æ˜¯customï¼Œå¼ºåˆ¶æ˜¾ç¤ºè‡ªå®šä¹‰æ¨¡å‹è¡Œ
        if (modelSelect.value === 'custom') {
            console.log('é¢å¤–å¼ºåˆ¶æ£€æŸ¥ï¼šé€‰æ‹©æ¡†æ˜¯customï¼Œå¼ºåˆ¶æ˜¾ç¤ºè‡ªå®šä¹‰æ¨¡å‹è¡Œ');
            customModelRow.style.display = 'block';
            customModelInput.required = true;
            console.log('å¼ºåˆ¶è®¾ç½®åçš„æ˜¾ç¤ºçŠ¶æ€:', customModelRow.style.display);
        }
        
        // æ·»åŠ é¢å¤–çš„æ£€æŸ¥ï¼Œç¡®ä¿çŠ¶æ€æ­£ç¡®
        setTimeout(function() {
            console.log('å»¶è¿Ÿæ£€æŸ¥ - å½“å‰çŠ¶æ€:');
            console.log('æ¨¡å‹é€‰æ‹©æ¡†å€¼:', modelSelect.value);
            console.log('è‡ªå®šä¹‰æ¨¡å‹è¾“å…¥æ¡†å€¼:', customModelInput.value);
            console.log('è‡ªå®šä¹‰æ¨¡å‹è¡Œæ˜¾ç¤ºçŠ¶æ€:', customModelRow.style.display);
            
            // å¼ºåˆ¶ä¿®å¤ï¼šå¦‚æœè‡ªå®šä¹‰æ¨¡å‹è¾“å…¥æ¡†æœ‰å€¼ä½†è¡Œè¢«éšè—ï¼Œå¼ºåˆ¶æ˜¾ç¤º
            if (customModelInput.value && customModelInput.value.trim() && customModelRow.style.display === 'none') {
                console.log('å¼ºåˆ¶ä¿®å¤ï¼šæ˜¾ç¤ºè‡ªå®šä¹‰æ¨¡å‹è¡Œ');
                customModelRow.style.display = 'block';
                customModelInput.required = true;
                if (modelSelect.value !== 'custom') {
                    modelSelect.value = 'custom';
                    console.log('å¼ºåˆ¶è®¾ç½®é€‰æ‹©æ¡†ä¸ºcustom');
                }
            }
        }, 100);
        
        // å†æ¬¡å»¶è¿Ÿæ£€æŸ¥ï¼Œç¡®ä¿ä¿®å¤ç”Ÿæ•ˆ
        setTimeout(function() {
            console.log('æœ€ç»ˆæ£€æŸ¥ - å½“å‰çŠ¶æ€:');
            console.log('æ¨¡å‹é€‰æ‹©æ¡†å€¼:', modelSelect.value);
            console.log('è‡ªå®šä¹‰æ¨¡å‹è¾“å…¥æ¡†å€¼:', customModelInput.value);
            console.log('è‡ªå®šä¹‰æ¨¡å‹è¡Œæ˜¾ç¤ºçŠ¶æ€:', customModelRow.style.display);
            
            // æœ€ç»ˆå¼ºåˆ¶ä¿®å¤
            if (customModelInput.value && customModelInput.value.trim() && customModelInput.value !== 'none') {
                console.log('æœ€ç»ˆå¼ºåˆ¶ä¿®å¤ï¼šç¡®ä¿è‡ªå®šä¹‰æ¨¡å‹æ­£ç¡®æ˜¾ç¤º');
                customModelRow.style.display = 'block';
                customModelInput.required = true;
                if (modelSelect.value !== 'custom') {
                    modelSelect.value = 'custom';
                    console.log('æœ€ç»ˆå¼ºåˆ¶è®¾ç½®é€‰æ‹©æ¡†ä¸ºcustom');
                }
            }
            
            // é¢å¤–å¼ºåˆ¶ä¿®å¤ï¼šå¦‚æœé€‰æ‹©æ¡†æ˜¯customï¼Œå¼ºåˆ¶æ˜¾ç¤ºè‡ªå®šä¹‰æ¨¡å‹è¡Œ
            if (modelSelect.value === 'custom') {
                console.log('æœ€ç»ˆå¼ºåˆ¶ä¿®å¤ï¼šé€‰æ‹©æ¡†æ˜¯customï¼Œå¼ºåˆ¶æ˜¾ç¤ºè‡ªå®šä¹‰æ¨¡å‹è¡Œ');
                customModelRow.style.display = 'block';
                customModelInput.required = true;
                console.log('æœ€ç»ˆå¼ºåˆ¶è®¾ç½®åçš„æ˜¾ç¤ºçŠ¶æ€:', customModelRow.style.display);
            }
        }, 500);
        
        // æœ€åçš„å®‰å…¨æ£€æŸ¥
        setTimeout(function() {
            console.log('æœ€åå®‰å…¨æ£€æŸ¥ - å½“å‰çŠ¶æ€:');
            console.log('æ¨¡å‹é€‰æ‹©æ¡†å€¼:', modelSelect.value);
            console.log('è‡ªå®šä¹‰æ¨¡å‹è¾“å…¥æ¡†å€¼:', customModelInput.value);
            console.log('è‡ªå®šä¹‰æ¨¡å‹è¡Œæ˜¾ç¤ºçŠ¶æ€:', customModelRow.style.display);
            
            // å¦‚æœè¿˜æ˜¯è¢«éšè—ï¼Œå¼ºåˆ¶æ˜¾ç¤º
            if (modelSelect.value === 'custom' && customModelRow.style.display === 'none') {
                console.log('æœ€åå®‰å…¨æ£€æŸ¥ï¼šå¼ºåˆ¶æ˜¾ç¤ºè‡ªå®šä¹‰æ¨¡å‹è¡Œ');
                customModelRow.style.display = 'block';
                customModelInput.required = true;
                console.log('æœ€åå¼ºåˆ¶è®¾ç½®åçš„æ˜¾ç¤ºçŠ¶æ€:', customModelRow.style.display);
            }
        }, 1000);
    });
</script>
{% endblock %}
