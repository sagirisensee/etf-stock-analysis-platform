{% extends "base.html" %}

{% block title %}智能分析 - AI量化投资分析平台{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>智能分析
                </h4>
                <p class="text-muted mb-0 mt-2">对您的投资标的进行AI驱动的量化分析</p>
            </div>
            <div class="card-body">
                <!-- ETF池分析区域 -->
                <div class="mb-4">
                    <h5 class="text-primary mb-3">
                        <i class="fas fa-chart-pie me-2"></i>ETF池分析
                    </h5>
                    <div id="etfPoolContainer" class="row">
                        <!-- ETF标的将在这里动态加载 -->
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-primary btn-lg" onclick="startBatchAnalysis('etf')">
                            <i class="fas fa-play me-2"></i>分析所有ETF
                        </button>
                        <button class="btn btn-outline-primary btn-lg ms-2" onclick="startBatchAnalysis('etf_debug')">
                            <i class="fas fa-chart-bar me-2"></i>数据指标
                        </button>
                    </div>
                </div>

                <hr class="my-4">

                <!-- 股票池分析区域 -->
                <div class="mb-4">
                    <h5 class="text-success mb-3">
                        <i class="fas fa-chart-line me-2"></i>股票池分析
                    </h5>
                    <div id="stockPoolContainer" class="row">
                        <!-- 股票标的将在这里动态加载 -->
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-success btn-lg" onclick="startBatchAnalysis('stock')">
                            <i class="fas fa-play me-2"></i>分析所有股票
                        </button>
                        <button class="btn btn-outline-success btn-lg ms-2" onclick="startBatchAnalysis('stock_debug')">
                            <i class="fas fa-chart-bar me-2"></i>数据指标
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 加载状态弹窗 -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-labelledby="loadingModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-5">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">分析中...</span>
                </div>
                <h5 class="mt-3" id="loadingTitle">AI分析进行中...</h5>
                <p class="text-muted" id="loadingDescription">正在获取数据并进行智能分析，请稍候</p>
                <div class="progress mt-3" style="max-width: 400px; margin: 0 auto;">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 分析结果 -->
<div id="resultsSection" style="display: none;">
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>分析结果
                        <span id="analysisType" class="badge bg-primary ms-2"></span>
                    </h5>
                    <div>
                        <small class="text-muted me-3">
                            <i class="fas fa-clock me-1"></i>
                            分析时间：<span id="analysisTime"></span>
                        </small>
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportResults()">
                            <i class="fas fa-download me-1"></i>导出
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="resultsContent">
                        <!-- 分析结果将在这里动态加载 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 分析历史快速访问 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>最近分析
                </h5>
            </div>
            <div class="card-body">
                <div id="recentAnalysis">
                    <div class="text-center py-3">
                        <i class="fas fa-clock fa-2x text-muted mb-2"></i>
                        <p class="text-muted">暂无分析记录，开始您的第一次分析吧！</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI分析结果弹窗 -->
<div class="modal fade" id="aiAnalysisModal" tabindex="-1" aria-labelledby="aiAnalysisModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="aiAnalysisModalLabel">
                    <i class="fas fa-robot me-2"></i>AI分析结果
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="aiAnalysisContent">
                    <!-- AI分析内容将在这里动态加载 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="exportAIAnalysis()">
                    <i class="fas fa-download me-1"></i>导出结果
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 数据指标弹窗 -->
<div class="modal fade" id="dataIndicatorsModal" tabindex="-1" aria-labelledby="dataIndicatorsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dataIndicatorsModalLabel">
                    <i class="fas fa-chart-bar me-2"></i>数据指标分析
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="dataIndicatorsContent">
                    <!-- 数据指标内容将在这里动态加载 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="exportDataIndicators()">
                    <i class="fas fa-download me-1"></i>导出数据
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentAnalysisData = null;
    let etfPools = [];
    let stockPools = [];
    let recentAnalysisPollingTimer = null;
    let lastAnalysisTimestamp = null;

    // 页面加载时获取池子数据
    document.addEventListener('DOMContentLoaded', function() {
        loadPoolData();
        loadRecentAnalysis();
        
        // 启动定时器，每30秒检查一次是否有新的分析结果
        startRecentAnalysisPolling();
    });

    // 页面卸载时清理定时器
    window.addEventListener('beforeunload', function() {
        stopRecentAnalysisPolling();
    });

    // 加载池子数据
    async function loadPoolData() {
        try {
            const response = await fetch('/api/pools');
            
            // 检查响应状态
            if (response.status === 401 || response.status === 403) {
                // 未登录状态，显示默认池子数据
                etfPools = [];
                stockPools = [];
                renderPoolCards();
                return;
            }
            
            // 检查响应内容类型
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                // 如果返回的不是JSON（可能是HTML登录页面），说明未登录
                etfPools = [];
                stockPools = [];
                renderPoolCards();
                return;
            }
            
            const data = await response.json();
            
            if (data.success) {
                etfPools = data.etf_pools || [];
                stockPools = data.stock_pools || [];
                renderPoolCards();
            } else {
                showAlert('加载池子数据失败: ' + data.error, 'danger');
            }
        } catch (error) {
            // 如果是JSON解析错误，可能是未登录，不显示错误
            if (error.message.includes('Unexpected token')) {
                etfPools = [];
                stockPools = [];
                renderPoolCards();
            } else {
                showAlert('加载池子数据失败: ' + error.message, 'danger');
            }
        }
    }

    // 渲染池子卡片
    function renderPoolCards() {
        renderPoolCardsByType('etf', etfPools);
        renderPoolCardsByType('stock', stockPools);
    }

    // 渲染指定类型的池子卡片
    function renderPoolCardsByType(type, pools) {
        const container = document.getElementById(type + 'PoolContainer');
        if (!container) return;

        if (pools.length === 0) {
            container.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle me-2"></i>
                        暂无${type === 'etf' ? 'ETF' : '股票'}标的，请先前往<a href="/pools" class="alert-link">标的池管理</a>添加
                    </div>
                </div>
            `;
            return;
        }

        container.innerHTML = pools.map(pool => `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card h-100 border-${type === 'etf' ? 'primary' : 'success'}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0">${pool.name}</h6>
                            <span class="badge bg-${type === 'etf' ? 'primary' : 'success'}">${pool.code}</span>
                        </div>
                        <p class="card-text text-muted small mb-3">${type === 'etf' ? 'ETF基金' : '股票'}</p>
                        <div class="d-grid gap-2">
                            <button class="btn btn-${type === 'etf' ? 'primary' : 'success'} btn-sm" 
                                    onclick="startIndividualAnalysis('${type}', '${pool.code}', '${pool.name}')">
                                <i class="fas fa-chart-line me-1"></i>单独分析
                            </button>
                            <button class="btn btn-outline-${type === 'etf' ? 'primary' : 'success'} btn-sm" 
                                    onclick="startIndividualAnalysis('${type}_debug', '${pool.code}', '${pool.name}')">
                                <i class="fas fa-chart-bar me-1"></i>数据指标
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // 开始个别分析
    async function startIndividualAnalysis(type, code, name) {
        // 显示加载弹窗
        showLoadingModal(type);
        
        // 重置进度条
        const progressBar = document.getElementById('progressBar');
        progressBar.style.width = '0%';
        
        // 智能进度更新 - 更接近实际分析进度
        let progress = 0;
        let startTime = Date.now();
        const progressInterval = setInterval(() => {
            const elapsed = Date.now() - startTime;
            const elapsedSeconds = elapsed / 1000;
            
            // 根据时间动态调整进度
            if (elapsedSeconds < 5) {
                // 前5秒：快速到30%
                progress = Math.min(30, elapsedSeconds * 6);
            } else if (elapsedSeconds < 15) {
                // 5-15秒：缓慢增长到60%
                progress = 30 + (elapsedSeconds - 5) * 3;
            } else if (elapsedSeconds < 30) {
                // 15-30秒：更慢增长到75%
                progress = 60 + (elapsedSeconds - 15) * 1;
            } else {
                // 30秒后：缓慢增长到85%
                progress = Math.min(85, 75 + (elapsedSeconds - 30) * 0.3);
            }
            
            progressBar.style.width = progress + '%';
        }, 500); // 每0.5秒更新一次
        
        try {
            const response = await fetch(`/api/analyze/${type}?code=${code}&name=${encodeURIComponent(name)}`);
            
            // 检查响应状态
            if (!response.ok) {
                throw new Error(`服务器错误: ${response.status} ${response.statusText}`);
            }
            
            // 检查响应内容类型
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                throw new Error(`服务器返回了非JSON响应: ${text.substring(0, 100)}...`);
            }
            
            const result = await response.json();
            
            // 完成进度条
            clearInterval(progressInterval);
            progressBar.style.width = '100%';
            
            if (result.success) {
                currentAnalysisData = result.data;
                displayResults(result.data, type, result.timestamp);
            } else {
                const errorMessage = `
                    <strong>分析失败！</strong><br>
                    <small>${result.error || '未知错误'}</small><br>
                    <small class="mt-2">请检查：<br>
                    1. 标的池是否已配置<br>
                    2. AI模型配置是否正确<br>
                    3. API密钥是否有效</small>
                `;
                showAlert(errorMessage, 'danger');
            }
        } catch (error) {
            clearInterval(progressInterval);
            let errorMessage = '';
            
            if (error.message.includes('Unexpected token')) {
                errorMessage = `
                    <strong>数据获取失败！</strong><br>
                    <small>服务器返回了错误页面，可能是数据源暂时不可用</small><br>
                    <small class="mt-2">建议：<br>
                    1. 稍后重试<br>
                    2. 检查网络连接<br>
                    3. 联系管理员</small>
                `;
            } else if (error.message.includes('504') || error.message.includes('Gateway Timeout')) {
                errorMessage = `
                    <strong>请求超时！</strong><br>
                    <small>分析耗时过长，请稍后在分析历史处查看结果</small><br>
                    <small class="mt-2">通常需要几分钟时间完成分析</small>
                `;
            } else {
                errorMessage = `
                    <strong>分析请求失败！</strong><br>
                    <small>错误详情：${error.message}</small><br>
                    <small class="mt-2">请刷新页面后重试</small>
                `;
            }
            
            showAlert(errorMessage, 'danger');
        } finally {
            // 隐藏加载弹窗
            hideLoadingModal();
        }
    }

    // 开始批量分析
    async function startBatchAnalysis(type) {
        // 显示加载弹窗
        showLoadingModal(type);
        
        // 重置进度条
        const progressBar = document.getElementById('progressBar');
        progressBar.style.width = '0%';
        
        // 智能进度更新 - 更接近实际分析进度
        let progress = 0;
        let startTime = Date.now();
        const progressInterval = setInterval(() => {
            const elapsed = Date.now() - startTime;
            const elapsedSeconds = elapsed / 1000;
            
            // 根据时间动态调整进度
            if (elapsedSeconds < 5) {
                // 前5秒：快速到30%
                progress = Math.min(30, elapsedSeconds * 6);
            } else if (elapsedSeconds < 15) {
                // 5-15秒：缓慢增长到60%
                progress = 30 + (elapsedSeconds - 5) * 3;
            } else if (elapsedSeconds < 30) {
                // 15-30秒：更慢增长到75%
                progress = 60 + (elapsedSeconds - 15) * 1;
            } else {
                // 30秒后：缓慢增长到85%
                progress = Math.min(85, 75 + (elapsedSeconds - 30) * 0.3);
            }
            
            progressBar.style.width = progress + '%';
        }, 500); // 每0.5秒更新一次
        
        try {
            const response = await fetch(`/api/analyze/${type}`);
            
            // 检查响应状态
            if (!response.ok) {
                throw new Error(`服务器错误: ${response.status} ${response.statusText}`);
            }
            
            // 检查响应内容类型
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                throw new Error(`服务器返回了非JSON响应: ${text.substring(0, 100)}...`);
            }
            
            const result = await response.json();
            
            // 完成进度条
            clearInterval(progressInterval);
            progressBar.style.width = '100%';
            
            if (result.success) {
                currentAnalysisData = result.data;
                displayResults(result.data, type, result.timestamp);
            } else {
                const errorMessage = `
                    <strong>分析失败！</strong><br>
                    <small>${result.error || '未知错误'}</small><br>
                    <small class="mt-2">请检查：<br>
                    1. 标的池是否已配置<br>
                    2. AI模型配置是否正确<br>
                    3. API密钥是否有效</small>
                `;
                showAlert(errorMessage, 'danger');
            }
        } catch (error) {
            clearInterval(progressInterval);
            let errorMessage = '';
            
            if (error.message.includes('Unexpected token')) {
                errorMessage = `
                    <strong>数据获取失败！</strong><br>
                    <small>服务器返回了错误页面，可能是数据源暂时不可用</small><br>
                    <small class="mt-2">建议：<br>
                    1. 稍后重试<br>
                    2. 检查网络连接<br>
                    3. 联系管理员</small>
                `;
            } else if (error.message.includes('504') || error.message.includes('Gateway Timeout')) {
                errorMessage = `
                    <strong>请求超时！</strong><br>
                    <small>分析耗时过长，请稍后在分析历史处查看结果</small><br>
                    <small class="mt-2">通常需要几分钟时间完成分析</small>
                `;
            } else {
                errorMessage = `
                    <strong>分析请求失败！</strong><br>
                    <small>错误详情：${error.message}</small><br>
                    <small class="mt-2">请刷新页面后重试</small>
                `;
            }
            
            showAlert(errorMessage, 'danger');
        } finally {
            // 隐藏加载弹窗
            hideLoadingModal();
        }
    }

    // 开始分析（保持向后兼容）
    async function startAnalysis(type) {
        return startBatchAnalysis(type);
    }

    // 显示分析结果
    function displayResults(data, type, timestamp) {
        const resultsSection = document.getElementById('resultsSection');
        const resultsContent = document.getElementById('resultsContent');
        const analysisTypeSpan = document.getElementById('analysisType');
        const analysisTimeSpan = document.getElementById('analysisTime');
        
        // 设置分析类型和时间
        const typeNames = {
            'etf': 'ETF分析',
            'stock': '股票分析',
            'etf_debug': 'ETF数据指标',
            'stock_debug': '股票数据指标'
        };
        analysisTypeSpan.textContent = typeNames[type] || type;
        analysisTimeSpan.textContent = formatDateTime(timestamp);
        
        // 生成结果HTML
        let html = '';
        
        if (type.includes('debug')) {
            // 数据指标结果 - 使用弹窗显示
            showDataIndicatorsModal(data, type);
        } else {
            // AI分析结果 - 也使用弹窗显示
            showAIAnalysisModal(data, type);
        }
        
        // 更新最近分析
        updateRecentAnalysis(type, timestamp, data ? data.length : 0);
        
        // 刷新最近分析显示
        setTimeout(() => {
            loadRecentAnalysis();
        }, 1000); // 延迟1秒，确保数据已保存到数据库
    }

    // 获取评分样式类
    function getScoreClass(score) {
        if (score >= 80) return 'excellent';
        if (score >= 60) return 'good';
        if (score >= 40) return 'average';
        return 'poor';
    }

    // 切换技术指标显示
    function toggleTechnicalIndicators(index) {
        const summaryDiv = document.getElementById(`indicators-${index}-summary`);
        const fullDiv = document.getElementById(`indicators-${index}-full`);
        const button = event.target.closest('button');
        
        if (summaryDiv.style.display === 'none') {
            // 显示摘要，隐藏完整
            summaryDiv.style.display = 'block';
            fullDiv.style.display = 'none';
            button.innerHTML = '<i class="fas fa-eye me-1"></i>查看详情';
        } else {
            // 隐藏摘要，显示完整
            summaryDiv.style.display = 'none';
            fullDiv.style.display = 'block';
            button.innerHTML = '<i class="fas fa-eye-slash me-1"></i>收起详情';
        }
    }

    // 生成AI分析结果HTML
    function generateAIResults(data) {
        if (!data || data.length === 0) {
            return '<div class="text-center py-4"><i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i><p>暂无分析数据</p></div>';
        }
        
        let html = '<div class="row">';
        
        data.forEach((item, index) => {
            // 处理数据缺失情况
            let scoreClass, scoreDisplay;
            if (item.ai_score === "数据缺失") {
                scoreClass = "score-badge-data-missing";
                scoreDisplay = "数据缺失";
            } else {
                scoreClass = getScoreClass(item.ai_score || 0);
                scoreDisplay = item.ai_score || 0;
            }
            const rank = index + 1;
            
            html += `
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h5 class="card-title mb-1">
                                        <span class="badge bg-secondary me-2">#${rank}</span>
                                        ${item.name || '未知'}
                                    </h5>
                                    <p class="text-muted mb-0">
                                        <code>${item.code || 'N/A'}</code>
                                    </p>
                                </div>
                                <div class="score-badge ${scoreClass}">
                                    ${scoreDisplay}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <small class="text-muted">价格信息</small>
                                <div class="d-flex justify-content-between">
                                    <span>最新价：<strong>${item.price || 'N/A'}</strong></span>
                                    <span class="${(item.涨跌幅 || 0) >= 0 ? 'text-success' : 'text-danger'}">
                                        ${(item.涨跌幅 || 0) >= 0 ? '+' : ''}${(item.涨跌幅 || 0).toFixed(2)}%
                                    </span>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <small class="text-muted">AI点评</small>
                                <p class="small">
                                    ${item.ai_comment ? 
                                        (item.ai_comment.includes('LLM分析服务异常') || item.ai_comment.includes('AI分析服务') ?
                                            `<span class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>${item.ai_comment}</span>` :
                                            item.ai_comment
                                        ) : 
                                        '暂无点评'
                                    }
                                </p>
                            </div>
                            
                            <div class="mb-3">
                                <small class="text-muted">日线趋势</small>
                                <p class="mb-0">
                                    <span class="badge ${getStatusBadgeClass(item.daily_trend_status)}">
                                        ${item.daily_trend_status || '未知状态'}
                                    </span>
                                </p>
                            </div>
                            
                            ${item.analysis_points && item.analysis_points.length > 0 ? `
                                <div>
                                    <small class="text-muted">技术信号</small>
                                    <div class="mt-1">
                                        ${item.analysis_points.map(point => 
                                            `<span class="badge bg-light text-dark me-1 mb-1">${point}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${item.technical_indicators_summary && item.technical_indicators_summary.length > 0 ? `
                                <div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <small class="text-muted">技术指标</small>
                                        ${item.technical_indicators_summary.length > 3 ? 
                                            `<button class="btn btn-sm btn-outline-primary" onclick="toggleTechnicalIndicators(${index})">
                                                <i class="fas fa-eye me-1"></i>查看详情
                                            </button>` : ''}
                                    </div>
                                    <div class="mt-1 small">
                                        <div id="indicators-${index}-summary">
                                            ${item.technical_indicators_summary.slice(0, 3).map(indicator => 
                                                `<div class="mb-1">• ${indicator}</div>`
                                            ).join('')}
                                            ${item.technical_indicators_summary.length > 3 ? 
                                                `<div class="text-muted">...还有${item.technical_indicators_summary.length - 3}个指标</div>` : ''}
                                        </div>
                                        <div id="indicators-${index}-full" style="display: none;">
                                            ${item.technical_indicators_summary.map(indicator => 
                                                `<div class="mb-1">• ${indicator}</div>`
                                            ).join('')}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        return html;
    }

    // 生成数据指标结果HTML
    function generateDebugResults(data) {
        if (!data || data.length === 0) {
            return '<div class="text-center py-4"><i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i><p>暂无数据指标</p></div>';
        }
        
        let html = '<div class="row">';
        
        data.forEach((item, index) => {
            html += `
                <div class="col-12 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <h5>${item.name || '未知'}</h5>
                                    <p class="text-muted mb-1"><code>${item.code || 'N/A'}</code></p>
                                    <p class="mb-1">最新价：<strong>${item.price || 'N/A'}</strong></p>
                                    <p class="mb-0">
                                        涨跌幅：
                                        <span class="${(item.涨跌幅 || 0) >= 0 ? 'text-success' : 'text-danger'}">
                                            ${(item.涨跌幅 || 0) >= 0 ? '+' : ''}${(item.涨跌幅 || 0).toFixed(2)}%
                                        </span>
                                    </p>
                                </div>
                                
                                <div class="col-md-3">
                                    <h6>日线趋势</h6>
                                    <p class="mb-0">${item.daily_trend_status || '未知'}</p>
                                </div>
                                
                                <div class="col-md-3">
                                    <h6>盘中信号</h6>
                                    ${item.intraday_signals && item.intraday_signals.length > 0 ? 
                                        item.intraday_signals.map(signal => 
                                            `<span class="badge bg-info me-1 mb-1">${signal}</span>`
                                        ).join('') : 
                                        '<span class="text-muted">无特殊信号</span>'
                                    }
                                </div>
                                
                                <div class="col-md-3">
                                    <h6>技术指标</h6>
                                    ${item.technical_indicators_summary && item.technical_indicators_summary.length > 0 ? 
                                        `<div class="small">${item.technical_indicators_summary.map(indicator => 
                                            `<div class="mb-1">${indicator}</div>`
                                        ).join('')}</div>` : 
                                        '<span class="text-muted">数据不足</span>'
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        return html;
    }

    // 更新最近分析
    function updateRecentAnalysis(type, timestamp, count) {
        const recentAnalysis = document.getElementById('recentAnalysis');
        const typeNames = {
            'etf': 'ETF分析',
            'stock': '股票分析',
            'etf_debug': 'ETF数据指标',
            'stock_debug': '股票数据指标'
        };
        
        const html = `
            <div class="border rounded p-3">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${typeNames[type] || type}</h6>
                        <small class="text-muted d-block">
                            <i class="fas fa-clock me-1"></i>${formatDateTime(timestamp)}
                        </small>
                        <small class="text-muted">
                            <i class="fas fa-list me-1"></i>分析了 ${count} 个标的
                        </small>
                    </div>
                    <div class="ms-2 flex-shrink-0">
                        <button class="btn btn-sm btn-outline-primary" onclick="showCurrentResults()">
                            <i class="fas fa-eye me-1"></i>查看
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        recentAnalysis.innerHTML = html;
    }

    // 加载最近分析记录
    function loadRecentAnalysis() {
        fetch('/api/analysis-history?limit=1')
            .then(response => {
                // 检查响应状态
                if (response.status === 401 || response.status === 403) {
                    // 未登录状态，不显示最近分析
                    const recentAnalysis = document.getElementById('recentAnalysis');
                    recentAnalysis.innerHTML = `
                        <div class="text-center py-3">
                            <i class="fas fa-user-lock fa-2x text-muted mb-2"></i>
                            <p class="text-muted">请先登录查看分析历史</p>
                        </div>
                    `;
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // 检查响应内容类型
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    // 如果返回的不是JSON（可能是HTML登录页面），说明未登录
                    const recentAnalysis = document.getElementById('recentAnalysis');
                    recentAnalysis.innerHTML = `
                        <div class="text-center py-3">
                            <i class="fas fa-user-lock fa-2x text-muted mb-2"></i>
                            <p class="text-muted">请先登录查看分析历史</p>
                        </div>
                    `;
                    return;
                }
                
                return response.json();
            })
            .then(data => {
                if (!data) return; // 如果上面已经处理了未登录情况
                
                if (data.success && data.data && data.data.length > 0) {
                    const latestRecord = data.data[0];
                    displayRecentAnalysis(latestRecord);
                    // 记录时间戳，用于后续比较
                    lastAnalysisTimestamp = latestRecord.created_at;
                } else {
                    // 没有历史记录，显示默认提示
                    const recentAnalysis = document.getElementById('recentAnalysis');
                    recentAnalysis.innerHTML = `
                        <div class="text-center py-3">
                            <i class="fas fa-clock fa-2x text-muted mb-2"></i>
                            <p class="text-muted">暂无分析记录，开始您的第一次分析吧！</p>
                        </div>
                    `;
                    lastAnalysisTimestamp = null;
                }
            })
            .catch(error => {
                console.error('加载最近分析失败:', error);
                // 显示错误信息
                const recentAnalysis = document.getElementById('recentAnalysis');
                recentAnalysis.innerHTML = `
                    <div class="text-center py-3">
                        <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                        <p class="text-muted">加载分析历史失败: ${error.message}</p>
                        <button class="btn btn-sm btn-outline-primary" onclick="loadRecentAnalysis()">重试</button>
                    </div>
                `;
            });
    }

    // 显示最近分析记录
    function displayRecentAnalysis(record) {
        const recentAnalysis = document.getElementById('recentAnalysis');
        
        const typeName = getTypeDisplayName(record.analysis_type);
        const badgeClass = getTypeBadgeClass(record.analysis_type);
        
        // 计算标的数量（从results字段解析）
        let count = 0;
        try {
            if (record.results) {
                const results = typeof record.results === 'string' ? JSON.parse(record.results) : record.results;
                count = results ? results.length : 0;
            }
        } catch (e) {
            count = 0;
        }
        
        const html = `
            <div class="border rounded p-3">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1 flex-wrap">
                            <h6 class="mb-0 me-2">${typeName}</h6>
                            <span class="badge ${badgeClass}">${typeName}</span>
                        </div>
                        <small class="text-muted d-block">
                            <i class="fas fa-clock me-1"></i>${formatDateTime(record.created_at)}
                        </small>
                        <small class="text-muted">
                            <i class="fas fa-list me-1"></i>分析了 ${count} 个标的
                        </small>
                    </div>
                    <div class="ms-2 flex-shrink-0">
                        <button class="btn btn-sm btn-outline-primary" onclick="showRecentAnalysisDetail(${record.id})">
                            <i class="fas fa-eye me-1"></i>查看
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        recentAnalysis.innerHTML = html;
    }

    // 显示最近分析详情
    function showRecentAnalysisDetail(recordId) {
        // 获取分析详情并显示在模态框中
        fetch(`/api/history/${recordId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    displayHistoryDetail(data.data);
                } else {
                    alert('获取分析详情失败');
                }
            })
            .catch(error => {
                console.error('获取分析详情失败:', error);
                alert('获取分析详情失败');
            });
    }

    // 显示历史详情（复用历史页面的逻辑）
    function displayHistoryDetail(record) {
        // 解析结果数据
        let results = [];
        try {
            if (record.results) {
                results = typeof record.results === 'string' ? JSON.parse(record.results) : record.results;
            }
        } catch (e) {
            console.error('解析results字段失败:', e);
        }

        // 构建详情HTML
        let detailHtml = `
            <div class="modal fade" id="historyDetailModal" tabindex="-1">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-chart-line me-2"></i>分析详情
                                <span class="badge bg-primary ms-2">${record.analysis_type}</span>
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>分析时间:</strong> ${formatDateTime(record.created_at)}
                                </div>
                                <div class="col-md-6">
                                    <strong>分析标的数量:</strong> ${results.length} 个
                                </div>
                            </div>
        `;

        // 添加每个标的的详细信息
        if (results && results.length > 0) {
            detailHtml += '<div class="accordion" id="analysisAccordion">';
            
            results.forEach((item, index) => {
                const dailyTrendStatus = item.daily_trend_status || '未知状态';
                const aiScore = item.ai_score || 'N/A';
                const aiComment = item.ai_comment || '暂无AI分析';
                
                detailHtml += `
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                                <div class="d-flex justify-content-between w-100 me-3">
                                    <div>
                                        <strong>${item.name}</strong> (${item.code})
                                    </div>
                                    <div class="text-end">
                                        <span class="badge me-2 ${(item.涨跌幅 || 0) > 0 ? 'bg-danger text-white' : ((item.涨跌幅 || 0) < 0 ? 'bg-success text-white' : 'bg-warning text-dark')}">
                                            ${(item.涨跌幅 || 0) !== null && (item.涨跌幅 || 0) !== undefined ? 
                                                ((item.涨跌幅 || 0) > 0 ? '+' : '') + (item.涨跌幅 || 0).toFixed(2) + '%' : 
                                                'N/A'
                                            }
                                        </span>
                                        <span class="badge bg-primary me-2">AI评分: ${aiScore}</span>
                                        <span class="badge ${getTrendBadgeClass(dailyTrendStatus)}">${dailyTrendStatus}</span>
                                    </div>
                                </div>
                            </button>
                        </h2>
                        <div id="collapse${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                             data-bs-parent="#analysisAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>技术指标分析</h6>
                                        <div class="technical-analysis">
                                            ${item.technical_indicators_summary && item.technical_indicators_summary.length > 0 ? 
                                                item.technical_indicators_summary.join('<br>') : 
                                                '暂无技术分析'
                                            }
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>AI投资建议</h6>
                                        <div class="ai-comment">
                                            ${aiComment.includes('LLM分析服务异常') || aiComment.includes('AI分析服务') ?
                                                `<span class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>${aiComment}</span>` :
                                                aiComment
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            detailHtml += '</div>';
        }

        detailHtml += `
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // 移除已存在的模态框
        const existingModal = document.getElementById('historyDetailModal');
        if (existingModal) {
            existingModal.remove();
        }

        // 添加新的模态框到页面
        document.body.insertAdjacentHTML('beforeend', detailHtml);

        // 显示模态框
        const modal = new bootstrap.Modal(document.getElementById('historyDetailModal'));
        modal.show();

        // 模态框关闭时移除DOM元素
        document.getElementById('historyDetailModal').addEventListener('hidden.bs.modal', function() {
            this.remove();
        });
    }

    // 根据趋势状态获取徽章样式
    function getTrendBadgeClass(status) {
        if (status.includes('强势上升') || status.includes('上升')) {
            return 'bg-success';
        } else if (status.includes('弱势下降') || status.includes('下降')) {
            return 'bg-danger';
        } else if (status.includes('震荡')) {
            return 'bg-warning';
        } else {
            return 'bg-secondary';
        }
    }

    // 启动最近分析轮询
    function startRecentAnalysisPolling() {
        // 如果已经有定时器在运行，先清除
        if (recentAnalysisPollingTimer) {
            clearInterval(recentAnalysisPollingTimer);
        }
        
        // 每30秒检查一次是否有新的分析结果
        recentAnalysisPollingTimer = setInterval(() => {
            checkForNewAnalysis();
        }, 30000); // 30秒
    }
    

    // 停止最近分析轮询
    function stopRecentAnalysisPolling() {
        if (recentAnalysisPollingTimer) {
            clearInterval(recentAnalysisPollingTimer);
            recentAnalysisPollingTimer = null;
        }
    }

    // 检查是否有新的分析结果
    function checkForNewAnalysis() {
        fetch('/api/analysis-history?limit=1')
            .then(response => {
                // 检查响应状态
                if (response.status === 401 || response.status === 403) {
                    // 未登录状态，停止轮询
                    stopRecentAnalysisPolling();
                    return;
                }
                
                // 检查响应内容类型
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    // 如果返回的不是JSON，说明未登录，停止轮询
                    stopRecentAnalysisPolling();
                    return;
                }
                
                return response.json();
            })
            .then(data => {
                if (!data) return; // 如果上面已经处理了未登录情况
                
                if (data.success && data.data.length > 0) {
                    const latestRecord = data.data[0];
                    const latestTimestamp = latestRecord.created_at;
                    
                    // 如果有新的分析结果（时间戳不同），更新显示
                    if (lastAnalysisTimestamp !== latestTimestamp) {
                        displayRecentAnalysis(latestRecord);
                        lastAnalysisTimestamp = latestTimestamp;
                    }
                }
            })
            .catch(error => {
                console.error('检查新分析结果失败:', error);
                // 如果是网络错误或解析错误，可能是未登录，停止轮询
                if (error.message.includes('Unexpected token') || error.message.includes('401') || error.message.includes('403')) {
                    stopRecentAnalysisPolling();
                }
            });
    }

    // 获取类型显示名称
    function getTypeDisplayName(analysisType) {
        const typeNames = {
            'etf': 'ETF分析',
            'stock': '股票分析',
            'etf_debug': 'ETF数据指标',
            'stock_debug': '股票数据指标'
        };
        return typeNames[analysisType] || analysisType;
    }

    // 获取类型徽章样式
    function getTypeBadgeClass(analysisType) {
        if (analysisType.includes('etf')) {
            return 'bg-primary';
        } else if (analysisType.includes('stock')) {
            return 'bg-success';
        }
        return 'bg-secondary';
    }

    // 显示当前结果
    function showCurrentResults() {
        if (currentAnalysisData) {
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }
    }

    // 导出结果
    function exportResults() {
        if (!currentAnalysisData) {
            showAlert('暂无数据可导出', 'warning');
            return;
        }
        
        const dataStr = JSON.stringify(currentAnalysisData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `analysis_results_${new Date().getTime()}.json`;
        link.click();
        URL.revokeObjectURL(url);
        
        showAlert('分析结果已导出', 'success');
    }

    // 获取状态徽章样式类
    function getStatusBadgeClass(status) {
        if (!status) return 'bg-secondary';
        
        if (status.includes('强势上升') || status.includes('上升趋势')) {
            return 'bg-success';
        } else if (status.includes('下降趋势') || status.includes('弱势')) {
            return 'bg-danger';
        } else if (status.includes('震荡') || status.includes('中性')) {
            return 'bg-warning text-dark';
        } else if (status.includes('数据不足') || status.includes('数据异常')) {
            return 'bg-info';
        } else if (status.includes('分析失败') || status.includes('错误')) {
            return 'bg-danger';
        } else {
            return 'bg-secondary';
        }
    }

    // 显示AI分析结果弹窗
    function showAIAnalysisModal(data, type) {
        const modal = new bootstrap.Modal(document.getElementById('aiAnalysisModal'));
        const content = document.getElementById('aiAnalysisContent');
        
        // 更新弹窗标题
        const title = document.getElementById('aiAnalysisModalLabel');
        const typeNames = {
            'etf': 'ETF AI分析结果',
            'stock': '股票AI分析结果'
        };
        title.innerHTML = `<i class="fas fa-robot me-2"></i>${typeNames[type] || 'AI分析结果'}`;
        
        // 生成AI分析内容
        content.innerHTML = generateAIResults(data);
        
        // 显示弹窗
        modal.show();
    }

    // 显示数据指标弹窗
    function showDataIndicatorsModal(data, type) {
        const modal = new bootstrap.Modal(document.getElementById('dataIndicatorsModal'));
        const content = document.getElementById('dataIndicatorsContent');
        
        // 更新弹窗标题
        const title = document.getElementById('dataIndicatorsModalLabel');
        const typeNames = {
            'etf_debug': 'ETF数据指标分析',
            'stock_debug': '股票数据指标分析'
        };
        title.innerHTML = `<i class="fas fa-chart-bar me-2"></i>${typeNames[type] || '数据指标分析'}`;
        
        // 生成数据指标内容
        content.innerHTML = generateDataIndicatorsContent(data);
        
        // 显示弹窗
        modal.show();
    }

    // 生成数据指标内容
    function generateDataIndicatorsContent(data) {
        if (!data || data.length === 0) {
            return '<div class="text-center py-4"><i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i><p>暂无数据指标</p></div>';
        }
        
        let html = '<div class="row">';
        
        data.forEach((item, index) => {
            html += `
                <div class="col-12 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <h5>${item.name || '未知'}</h5>
                                    <p class="text-muted mb-1"><code>${item.code || 'N/A'}</code></p>
                                    <p class="mb-1">最新价：<strong>${item.price || 'N/A'}</strong></p>
                                    <p class="mb-0">
                                        涨跌幅：
                                        <span class="${(item.涨跌幅 || 0) >= 0 ? 'text-success' : 'text-danger'}">
                                            ${(item.涨跌幅 || 0) >= 0 ? '+' : ''}${(item.涨跌幅 || 0).toFixed(2)}%
                                        </span>
                                    </p>
                                </div>
                                
                                <div class="col-md-3">
                                    <h6>日线趋势</h6>
                                    <p class="mb-0">
                                        <span class="badge ${getStatusBadgeClass(item.daily_trend_status)}">
                                            ${item.daily_trend_status || '未知状态'}
                                        </span>
                                    </p>
                                </div>
                                
                                <div class="col-md-3">
                                    <h6>盘中信号</h6>
                                    ${item.intraday_signals && item.intraday_signals.length > 0 ? 
                                        item.intraday_signals.map(signal => 
                                            `<span class="badge bg-info me-1 mb-1">${signal}</span>`
                                        ).join('') : 
                                        '<span class="text-muted">无特殊信号</span>'
                                    }
                                </div>
                                
                                <div class="col-md-3">
                                    <h6>技术指标</h6>
                                    ${item.technical_indicators_summary && item.technical_indicators_summary.length > 0 ? 
                                        `<div class="small">${item.technical_indicators_summary.map(indicator => 
                                            `<div class="mb-1">${indicator}</div>`
                                        ).join('')}</div>` : 
                                        '<span class="text-muted">数据不足</span>'
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        return html;
    }

    // 导出AI分析结果
    function exportAIAnalysis() {
        if (!currentAnalysisData) {
            showAlert('暂无数据可导出', 'warning');
            return;
        }
        
        const dataStr = JSON.stringify(currentAnalysisData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `ai_analysis_${new Date().getTime()}.json`;
        link.click();
        URL.revokeObjectURL(url);
        
        showAlert('AI分析结果已导出', 'success');
    }

    // 导出数据指标
    function exportDataIndicators() {
        if (!currentAnalysisData) {
            showAlert('暂无数据可导出', 'warning');
            return;
        }
        
        const dataStr = JSON.stringify(currentAnalysisData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `data_indicators_${new Date().getTime()}.json`;
        link.click();
        URL.revokeObjectURL(url);
        
        showAlert('数据指标已导出', 'success');
    }

    // 显示加载弹窗
    function showLoadingModal(type) {
        const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
        const title = document.getElementById('loadingTitle');
        const description = document.getElementById('loadingDescription');
        
        if (type.includes('debug')) {
            title.textContent = '数据指标获取中...';
            description.textContent = '正在获取历史数据并计算技术指标，请稍候';
        } else {
            title.textContent = 'AI分析进行中...';
            description.textContent = '正在获取数据并进行智能分析，请稍候';
        }
        
        modal.show();
    }

    // 隐藏加载弹窗
    function hideLoadingModal() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
        if (modal) {
            modal.hide();
        }
    }

</script>

<style>
.score-badge {
    font-size: 1.5rem;
    font-weight: bold;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    min-width: 80px;
    text-align: center;
}

.score-badge.excellent { background-color: #d4edda; color: #155724; }
.score-badge.good { background-color: #cce5ff; color: #004085; }
.score-badge.average { background-color: #fff3cd; color: #856404; }
.score-badge.poor { background-color: #f8d7da; color: #721c24; }
.score-badge-data-missing { 
    background-color: #f8f9fa; 
    color: #6c757d; 
    border: 2px dashed #dee2e6;
    font-size: 1rem;
}
</style>
{% endblock %}
