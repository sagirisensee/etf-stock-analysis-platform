{% extends "base.html" %}

{% block title %}æ™ºèƒ½åˆ†æ - AIé‡åŒ–æŠ•èµ„åˆ†æå¹³å°{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>æ™ºèƒ½åˆ†æ
                </h4>
                <p class="text-muted mb-0 mt-2">å¯¹æ‚¨çš„æŠ•èµ„æ ‡çš„è¿›è¡ŒAIé©±åŠ¨çš„é‡åŒ–åˆ†æ</p>
            </div>
            <div class="card-body">
                <!-- ETFæ± åˆ†æåŒºåŸŸ -->
                <div class="mb-4">
                    <h5 class="text-primary mb-3">
                        <i class="fas fa-chart-pie me-2"></i>ETFæ± åˆ†æ
                    </h5>
                    <div id="etfPoolContainer" class="row">
                        <!-- ETFæ ‡çš„å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-primary btn-lg" onclick="startBatchAnalysis('etf')">
                            <i class="fas fa-play me-2"></i>åˆ†ææ‰€æœ‰ETF
                        </button>
                        <button class="btn btn-outline-primary btn-lg ms-2" onclick="startBatchAnalysis('etf_debug')">
                            <i class="fas fa-chart-bar me-2"></i>æ•°æ®æŒ‡æ ‡
                        </button>
                    </div>
                </div>

                <hr class="my-4">

                <!-- è‚¡ç¥¨æ± åˆ†æåŒºåŸŸ -->
                <div class="mb-4">
                    <h5 class="text-success mb-3">
                        <i class="fas fa-chart-line me-2"></i>è‚¡ç¥¨æ± åˆ†æ
                    </h5>
                    <div id="stockPoolContainer" class="row">
                        <!-- è‚¡ç¥¨æ ‡çš„å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-success btn-lg" onclick="startBatchAnalysis('stock')">
                            <i class="fas fa-play me-2"></i>åˆ†ææ‰€æœ‰è‚¡ç¥¨
                        </button>
                        <button class="btn btn-outline-success btn-lg ms-2" onclick="startBatchAnalysis('stock_debug')">
                            <i class="fas fa-chart-bar me-2"></i>æ•°æ®æŒ‡æ ‡
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- åŠ è½½çŠ¶æ€å¼¹çª— -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-labelledby="loadingModalLabel" data-bs-backdrop="static" data-bs-keyboard="false" inert>
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-5">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">åˆ†æä¸­...</span>
                </div>
                <h5 class="mt-3" id="loadingTitle">AIåˆ†æè¿›è¡Œä¸­...</h5>
                <p class="text-muted" id="loadingDescription">æ­£åœ¨è·å–æ•°æ®å¹¶è¿›è¡Œæ™ºèƒ½åˆ†æï¼Œè¯·ç¨å€™</p>
                <div class="progress mt-3" style="max-width: 400px; margin: 0 auto;">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- åˆ†æç»“æœ -->
<div id="resultsSection" style="display: none;">
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>åˆ†æç»“æœ
                        <span id="analysisType" class="badge bg-primary ms-2"></span>
                    </h5>
                    <div>
                        <small class="text-muted me-3">
                            <i class="fas fa-clock me-1"></i>
                            åˆ†ææ—¶é—´ï¼š<span id="analysisTime"></span>
                        </small>
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportResults()">
                            <i class="fas fa-download me-1"></i>å¯¼å‡º
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="resultsContent">
                        <!-- åˆ†æç»“æœå°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- åˆ†æå†å²å¿«é€Ÿè®¿é—® -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>æœ€è¿‘åˆ†æ
                </h5>
            </div>
            <div class="card-body">
                <div id="recentAnalysis">
                    <div class="text-center py-3">
                        <i class="fas fa-clock fa-2x text-muted mb-2"></i>
                        <p class="text-muted">æš‚æ— åˆ†æè®°å½•ï¼Œå¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡åˆ†æå§ï¼</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AIåˆ†æç»“æœå¼¹çª— -->
<div class="modal fade" id="aiAnalysisModal" tabindex="-1" aria-labelledby="aiAnalysisModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="aiAnalysisModalLabel">
                    <i class="fas fa-robot me-2"></i>AIåˆ†æç»“æœ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="aiAnalysisContent">
                    <!-- AIåˆ†æå†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <button type="button" class="btn btn-primary" onclick="exportAIAnalysis()">
                    <i class="fas fa-download me-1"></i>å¯¼å‡ºç»“æœ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- æ•°æ®æŒ‡æ ‡å¼¹çª— -->
<div class="modal fade" id="dataIndicatorsModal" tabindex="-1" aria-labelledby="dataIndicatorsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dataIndicatorsModalLabel">
                    <i class="fas fa-chart-bar me-2"></i>æ•°æ®æŒ‡æ ‡åˆ†æ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="dataIndicatorsContent">
                    <!-- æ•°æ®æŒ‡æ ‡å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <button type="button" class="btn btn-primary" onclick="exportDataIndicators()">
                    <i class="fas fa-download me-1"></i>å¯¼å‡ºæ•°æ®
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentAnalysisData = null;
    let etfPools = [];
    let stockPools = [];
    let recentAnalysisPollingTimer = null;
    let lastAnalysisTimestamp = null;

    // é¡µé¢åŠ è½½æ—¶è·å–æ± å­æ•°æ®
    document.addEventListener('DOMContentLoaded', function() {
        loadPoolData();
        loadRecentAnalysis();

        // å¯åŠ¨å®šæ—¶å™¨ï¼Œæ¯30ç§’æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦æœ‰æ–°çš„åˆ†æç»“æœ
        startRecentAnalysisPolling();
    });

    // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
    window.addEventListener('beforeunload', function() {
        stopRecentAnalysisPolling();
    });

    // åŠ è½½æ± å­æ•°æ®
    async function loadPoolData() {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const etfContainer = document.getElementById('etfPoolContainer');
        const stockContainer = document.getElementById('stockPoolContainer');
        if (etfContainer) {
            etfContainer.innerHTML = '<div class="text-center"><span class="fas fa-spinner fa-spin"></span> åŠ è½½ä¸­...</div>';
        }
        if (stockContainer) {
            stockContainer.innerHTML = '<div class="text-center"><span class="fas fa-spinner fa-spin"></span> åŠ è½½ä¸­...</div>';
        }

        try {
            const response = await fetch('/api/pools');

            // æ£€æŸ¥æ˜¯å¦é‡å®šå‘åˆ°ç™»å½•é¡µé¢
            if (response.redirected || response.url.includes('/login')) {
                showLoginRequired();
                return;
            }

            // æ£€æŸ¥401æœªæˆæƒ
            if (response.status === 401) {
                showLoginRequired();
                return;
            }

            // å…ˆè·å–æ–‡æœ¬ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯HTML
            const text = await response.text();

            // æ£€æŸ¥æ˜¯å¦æ˜¯HTMLï¼ˆç™»å½•é¡µé¢ï¼‰
            if (text.trim().startsWith('<') && text.includes('login')) {
                showLoginRequired();
                return;
            }

            // å°è¯•è§£æJSON
            let data;
            try {
                data = JSON.parse(text);
            } catch (e) {
                showLoginRequired();
                return;
            }

            if (data.success) {
                etfPools = data.etf_pools || [];
                stockPools = data.stock_pools || [];
                renderPoolCards();
            } else if (data.need_login) {
                console.log('APIè¦æ±‚ç™»å½•');
                showLoginRequired();
            } else {
                console.error('APIè¿”å›é”™è¯¯:', data.error);
                showAlert('åŠ è½½æ± å­æ•°æ®å¤±è´¥: ' + data.error, 'danger');
            }
        } catch (error) {
            console.error('åŠ è½½æ± å­æ•°æ®å¼‚å¸¸:', error);
            showLoginRequired();
        }
    }

    // æ¸²æŸ“æ± å­å¡ç‰‡
    function renderPoolCards() {
        renderPoolCardsByType('etf', etfPools);
        renderPoolCardsByType('stock', stockPools);
    }

    // æ¸²æŸ“æŒ‡å®šç±»å‹çš„æ± å­å¡ç‰‡
    function renderPoolCardsByType(type, pools) {
        const container = document.getElementById(type + 'PoolContainer');
        if (!container) return;

        if (pools.length === 0) {
            container.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle me-2"></i>
                        æš‚æ— ${type === 'etf' ? 'ETF' : 'è‚¡ç¥¨'}æ ‡çš„ï¼Œè¯·å…ˆå‰å¾€<a href="/pools" class="alert-link">æ ‡çš„æ± ç®¡ç†</a>æ·»åŠ 
                    </div>
                </div>
            `;
            return;
        }

        container.innerHTML = pools.map(pool => `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card h-100 border-${type === 'etf' ? 'primary' : 'success'}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0">${pool.name}</h6>
                            <span class="badge bg-${type === 'etf' ? 'primary' : 'success'}">${pool.code}</span>
                        </div>
                        <p class="card-text text-muted small mb-3">${type === 'etf' ? 'ETFåŸºé‡‘' : 'è‚¡ç¥¨'}</p>
                        <div class="d-grid gap-2">
                            <button class="btn btn-${type === 'etf' ? 'primary' : 'success'} btn-sm" 
                                    onclick="startIndividualAnalysis('${type}', '${pool.code}', '${pool.name}')">
                                <i class="fas fa-chart-line me-1"></i>å•ç‹¬åˆ†æ
                            </button>
                            <button class="btn btn-outline-${type === 'etf' ? 'primary' : 'success'} btn-sm" 
                                    onclick="startIndividualAnalysis('${type}_debug', '${pool.code}', '${pool.name}')">
                                <i class="fas fa-chart-bar me-1"></i>æ•°æ®æŒ‡æ ‡
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // å¼€å§‹ä¸ªåˆ«åˆ†æ
    async function startIndividualAnalysis(type, code, name) {
        // æ˜¾ç¤ºåŠ è½½å¼¹çª—
        showLoadingModal(type);
        
        // é‡ç½®è¿›åº¦æ¡
        const progressBar = document.getElementById('progressBar');
        progressBar.style.width = '0%';
        
        // æ™ºèƒ½è¿›åº¦æ›´æ–° - æ›´æ¥è¿‘å®é™…åˆ†æè¿›åº¦
        let progress = 0;
        let startTime = Date.now();
        const progressInterval = setInterval(() => {
            const elapsed = Date.now() - startTime;
            const elapsedSeconds = elapsed / 1000;
            
            // æ ¹æ®æ—¶é—´åŠ¨æ€è°ƒæ•´è¿›åº¦
            if (elapsedSeconds < 5) {
                // å‰5ç§’ï¼šå¿«é€Ÿåˆ°30%
                progress = Math.min(30, elapsedSeconds * 6);
            } else if (elapsedSeconds < 15) {
                // 5-15ç§’ï¼šç¼“æ…¢å¢é•¿åˆ°60%
                progress = 30 + (elapsedSeconds - 5) * 3;
            } else if (elapsedSeconds < 30) {
                // 15-30ç§’ï¼šæ›´æ…¢å¢é•¿åˆ°75%
                progress = 60 + (elapsedSeconds - 15) * 1;
            } else {
                // 30ç§’åï¼šç¼“æ…¢å¢é•¿åˆ°85%
                progress = Math.min(85, 75 + (elapsedSeconds - 30) * 0.3);
            }
            
            progressBar.style.width = progress + '%';
        }, 500); // æ¯0.5ç§’æ›´æ–°ä¸€æ¬¡
        
        try {
            const response = await fetch(`/api/analyze/${type}?code=${code}&name=${encodeURIComponent(name)}`);
            
            // æ£€æŸ¥å“åº”çŠ¶æ€
            if (!response.ok) {
                throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${response.status} ${response.statusText}`);
            }
            
            // æ£€æŸ¥å“åº”å†…å®¹ç±»å‹
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                throw new Error(`æœåŠ¡å™¨è¿”å›äº†éJSONå“åº”: ${text.substring(0, 100)}...`);
            }
            
            const result = await response.json();
            
            // å®Œæˆè¿›åº¦æ¡
            clearInterval(progressInterval);
            progressBar.style.width = '100%';
            
            if (result.success) {
                currentAnalysisData = result.data;
                displayResults(result.data, type, result.timestamp);
            } else {
                const errorMessage = `
                    <strong>åˆ†æå¤±è´¥ï¼</strong><br>
                    <small>${result.error || 'æœªçŸ¥é”™è¯¯'}</small><br>
                    <small class="mt-2">è¯·æ£€æŸ¥ï¼š<br>
                    1. æ ‡çš„æ± æ˜¯å¦å·²é…ç½®<br>
                    2. AIæ¨¡å‹é…ç½®æ˜¯å¦æ­£ç¡®<br>
                    3. APIå¯†é’¥æ˜¯å¦æœ‰æ•ˆ</small>
                `;
                showAlert(errorMessage, 'danger');
            }
        } catch (error) {
            clearInterval(progressInterval);
            let errorMessage = '';
            
            if (error.message.includes('Unexpected token')) {
                errorMessage = `
                    <strong>æ•°æ®è·å–å¤±è´¥ï¼</strong><br>
                    <small>æœåŠ¡å™¨è¿”å›äº†é”™è¯¯é¡µé¢ï¼Œå¯èƒ½æ˜¯æ•°æ®æºæš‚æ—¶ä¸å¯ç”¨</small><br>
                    <small class="mt-2">å»ºè®®ï¼š<br>
                    1. ç¨åé‡è¯•<br>
                    2. æ£€æŸ¥ç½‘ç»œè¿æ¥<br>
                    3. è”ç³»ç®¡ç†å‘˜</small>
                `;
            } else if (error.message.includes('504') || error.message.includes('Gateway Timeout')) {
                errorMessage = `
                    <strong>è¯·æ±‚è¶…æ—¶ï¼</strong><br>
                    <small>åˆ†æè€—æ—¶è¿‡é•¿ï¼Œè¯·ç¨ååœ¨åˆ†æå†å²å¤„æŸ¥çœ‹ç»“æœ</small><br>
                    <small class="mt-2">é€šå¸¸éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´å®Œæˆåˆ†æ</small>
                `;
            } else {
                errorMessage = `
                    <strong>åˆ†æè¯·æ±‚å¤±è´¥ï¼</strong><br>
                    <small>é”™è¯¯è¯¦æƒ…ï¼š${error.message}</small><br>
                    <small class="mt-2">è¯·åˆ·æ–°é¡µé¢åé‡è¯•</small>
                `;
            }
            
            showAlert(errorMessage, 'danger');
        } finally {
            // éšè—åŠ è½½å¼¹çª—
            hideLoadingModal();
        }
    }

    // å¼€å§‹æ‰¹é‡åˆ†æ
    async function startBatchAnalysis(type) {
        // æ˜¾ç¤ºåŠ è½½å¼¹çª—
        showLoadingModal(type);
        
        // é‡ç½®è¿›åº¦æ¡
        const progressBar = document.getElementById('progressBar');
        progressBar.style.width = '0%';
        
        // æ™ºèƒ½è¿›åº¦æ›´æ–° - æ›´æ¥è¿‘å®é™…åˆ†æè¿›åº¦
        let progress = 0;
        let startTime = Date.now();
        const progressInterval = setInterval(() => {
            const elapsed = Date.now() - startTime;
            const elapsedSeconds = elapsed / 1000;
            
            // æ ¹æ®æ—¶é—´åŠ¨æ€è°ƒæ•´è¿›åº¦
            if (elapsedSeconds < 5) {
                // å‰5ç§’ï¼šå¿«é€Ÿåˆ°30%
                progress = Math.min(30, elapsedSeconds * 6);
            } else if (elapsedSeconds < 15) {
                // 5-15ç§’ï¼šç¼“æ…¢å¢é•¿åˆ°60%
                progress = 30 + (elapsedSeconds - 5) * 3;
            } else if (elapsedSeconds < 30) {
                // 15-30ç§’ï¼šæ›´æ…¢å¢é•¿åˆ°75%
                progress = 60 + (elapsedSeconds - 15) * 1;
            } else {
                // 30ç§’åï¼šç¼“æ…¢å¢é•¿åˆ°85%
                progress = Math.min(85, 75 + (elapsedSeconds - 30) * 0.3);
            }
            
            progressBar.style.width = progress + '%';
        }, 500); // æ¯0.5ç§’æ›´æ–°ä¸€æ¬¡
        
        try {
            const response = await fetch(`/api/analyze/${type}`);
            
            // æ£€æŸ¥å“åº”çŠ¶æ€
            if (!response.ok) {
                throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${response.status} ${response.statusText}`);
            }
            
            // æ£€æŸ¥å“åº”å†…å®¹ç±»å‹
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                throw new Error(`æœåŠ¡å™¨è¿”å›äº†éJSONå“åº”: ${text.substring(0, 100)}...`);
            }
            
            const result = await response.json();
            
            // å®Œæˆè¿›åº¦æ¡
            clearInterval(progressInterval);
            progressBar.style.width = '100%';
            
            if (result.success) {
                currentAnalysisData = result.data;
                displayResults(result.data, type, result.timestamp);
            } else {
                const errorMessage = `
                    <strong>åˆ†æå¤±è´¥ï¼</strong><br>
                    <small>${result.error || 'æœªçŸ¥é”™è¯¯'}</small><br>
                    <small class="mt-2">è¯·æ£€æŸ¥ï¼š<br>
                    1. æ ‡çš„æ± æ˜¯å¦å·²é…ç½®<br>
                    2. AIæ¨¡å‹é…ç½®æ˜¯å¦æ­£ç¡®<br>
                    3. APIå¯†é’¥æ˜¯å¦æœ‰æ•ˆ</small>
                `;
                showAlert(errorMessage, 'danger');
            }
        } catch (error) {
            clearInterval(progressInterval);
            let errorMessage = '';
            
            if (error.message.includes('Unexpected token')) {
                errorMessage = `
                    <strong>æ•°æ®è·å–å¤±è´¥ï¼</strong><br>
                    <small>æœåŠ¡å™¨è¿”å›äº†é”™è¯¯é¡µé¢ï¼Œå¯èƒ½æ˜¯æ•°æ®æºæš‚æ—¶ä¸å¯ç”¨</small><br>
                    <small class="mt-2">å»ºè®®ï¼š<br>
                    1. ç¨åé‡è¯•<br>
                    2. æ£€æŸ¥ç½‘ç»œè¿æ¥<br>
                    3. è”ç³»ç®¡ç†å‘˜</small>
                `;
            } else if (error.message.includes('504') || error.message.includes('Gateway Timeout')) {
                errorMessage = `
                    <strong>è¯·æ±‚è¶…æ—¶ï¼</strong><br>
                    <small>åˆ†æè€—æ—¶è¿‡é•¿ï¼Œè¯·ç¨ååœ¨åˆ†æå†å²å¤„æŸ¥çœ‹ç»“æœ</small><br>
                    <small class="mt-2">é€šå¸¸éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´å®Œæˆåˆ†æ</small>
                `;
            } else {
                errorMessage = `
                    <strong>åˆ†æè¯·æ±‚å¤±è´¥ï¼</strong><br>
                    <small>é”™è¯¯è¯¦æƒ…ï¼š${error.message}</small><br>
                    <small class="mt-2">è¯·åˆ·æ–°é¡µé¢åé‡è¯•</small>
                `;
            }
            
            showAlert(errorMessage, 'danger');
        } finally {
            // éšè—åŠ è½½å¼¹çª—
            hideLoadingModal();
        }
    }

    // å¼€å§‹åˆ†æï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
    async function startAnalysis(type) {
        return startBatchAnalysis(type);
    }

    // æ˜¾ç¤ºåˆ†æç»“æœ
    function displayResults(data, type, timestamp) {
        // ç¡®ä¿ type æ˜¯å­—ç¬¦ä¸²
        if (typeof type !== 'string') {
            console.error('Invalid type:', type);
            type = String(type || 'etf');
        }

        const resultsSection = document.getElementById('resultsSection');
        const resultsContent = document.getElementById('resultsContent');
        const analysisTypeSpan = document.getElementById('analysisType');
        const analysisTimeSpan = document.getElementById('analysisTime');
        
        // è®¾ç½®åˆ†æç±»å‹å’Œæ—¶é—´
        const typeNames = {
            'etf': 'ETFåˆ†æ',
            'stock': 'è‚¡ç¥¨åˆ†æ',
            'etf_debug': 'ETFæ•°æ®æŒ‡æ ‡',
            'stock_debug': 'è‚¡ç¥¨æ•°æ®æŒ‡æ ‡'
        };
        analysisTypeSpan.textContent = typeNames[type] || type;
        analysisTimeSpan.textContent = formatDateTime(timestamp);
        
        // ç”Ÿæˆç»“æœHTML
        let html = '';
        
        if (type.includes('debug')) {
            // æ•°æ®æŒ‡æ ‡ç»“æœ - ä½¿ç”¨å¼¹çª—æ˜¾ç¤º
            showDataIndicatorsModal(data, type);
        } else {
            // AIåˆ†æç»“æœ - ä¹Ÿä½¿ç”¨å¼¹çª—æ˜¾ç¤º
            showAIAnalysisModal(data, type);
        }
        
        // æ›´æ–°æœ€è¿‘åˆ†æ
        updateRecentAnalysis(type, timestamp, data ? data.length : 0);
        
        // åˆ·æ–°æœ€è¿‘åˆ†ææ˜¾ç¤º
        setTimeout(() => {
            loadRecentAnalysis();
        }, 1000); // å»¶è¿Ÿ1ç§’ï¼Œç¡®ä¿æ•°æ®å·²ä¿å­˜åˆ°æ•°æ®åº“
    }

    // è·å–è¯„åˆ†æ ·å¼ç±»
    function getScoreClass(score) {
        if (score >= 80) return 'excellent';
        if (score >= 60) return 'good';
        if (score >= 40) return 'average';
        return 'poor';
    }

    // è·å–ä¿¡å·æ ·å¼ç±»
    function getSignalBadgeClass(signal) {
        switch(signal) {
            case 'å¼ºçƒˆä¹°å…¥': return 'bg-success';
            case 'ä¹°å…¥': return 'bg-primary';
            case 'æŒæœ‰': return 'bg-secondary';
            case 'å–å‡º': return 'bg-warning';
            case 'å¼ºçƒˆå–å‡º': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }

    // åˆ‡æ¢æŠ€æœ¯æŒ‡æ ‡æ˜¾ç¤º
    function toggleTechnicalIndicators(index) {
        const summaryDiv = document.getElementById(`indicators-${index}-summary`);
        const fullDiv = document.getElementById(`indicators-${index}-full`);
        const button = event.target.closest('button');
        
        if (summaryDiv.style.display === 'none') {
            // æ˜¾ç¤ºæ‘˜è¦ï¼Œéšè—å®Œæ•´
            summaryDiv.style.display = 'block';
            fullDiv.style.display = 'none';
            button.innerHTML = '<i class="fas fa-eye me-1"></i>æŸ¥çœ‹è¯¦æƒ…';
        } else {
            // éšè—æ‘˜è¦ï¼Œæ˜¾ç¤ºå®Œæ•´
            summaryDiv.style.display = 'none';
            fullDiv.style.display = 'block';
            button.innerHTML = '<i class="fas fa-eye-slash me-1"></i>æ”¶èµ·è¯¦æƒ…';
        }
    }

    // ç”Ÿæˆä¹°å–ä¿¡å·HTML
    function generateSignalHTML(signal_data) {
        if (!signal_data) {
            return '<span class="text-muted">æ— ä¿¡å·</span>';
        }
        
        const signalType = signal_data.signal_type || 'Hold';
        const signalScore = signal_data.signal_score || 50;
        const signalConfidence = signal_data.confidence || 0;
        const signalStrength = signal_data.signal_strength || 'Weak';
        
        // ä¿¡å·ç±»å‹æ ·å¼
        const signalStyles = {
            'Strong Buy': { badge: 'bg-success', icon: 'fa-arrow-up', text: 'å¼ºçƒˆä¹°å…¥' },
            'Buy': { badge: 'bg-success', icon: 'fa-arrow-up', text: 'ä¹°å…¥' },
            'Hold': { badge: 'bg-warning', icon: 'fa-minus', text: 'æŒæœ‰' },
            'Sell': { badge: 'bg-danger', icon: 'fa-arrow-down', text: 'å–å‡º' },
            'Strong Sell': { badge: 'bg-danger', icon: 'fa-arrow-down', text: 'å¼ºçƒˆå–å‡º' }
        };
        
        const style = signalStyles[signalType] || signalStyles['Hold'];
        const strengthClass = signalStrength === 'Strong' ? 'text-primary' : 'text-muted';
        
        return `
            <div class="signal-badge ${style.badge}">
                <i class="fas ${style.icon} me-1"></i>
                ${style.text}
                ${signalStrength === 'Strong' ? 'ï¼ˆå¼ºï¼‰' : 'ï¼ˆå¼±ï¼‰'}
            </div>
            <div class="mt-1 small text-muted">
                è¯„åˆ†ï¼š${signalScore.toFixed(1)}/100ï¼Œç½®ä¿¡åº¦ï¼š${signalConfidence.toFixed(0)}%
            </div>
            ${signal_data.signal_reasons && signal_data.signal_reasons.length > 0 ? `
                <div class="mt-1 small">
                    <span class="text-muted">ç†ç”±ï¼š</span>
                    ${signal_data.signal_reasons.slice(0, 2).join('ã€')}
                </div>
            ` : ''}
        `;
    }
    
    // ç”Ÿæˆå‰ç»æ€§æŒ‡æ ‡HTML
    function generateForwardIndicatorsHTML(forward_indicators) {
        if (!forward_indicators) {
            return '<span class="text-muted">æ— æ•°æ®</span>';
        }
        
        const rsi = forward_indicators.RSI_14;
        const kdj_k = forward_indicators.KDJ_K;
        const kdj_d = forward_indicators.KDJ_D;
        const kdj_j = forward_indicators.KDJ_J;
        const cci = forward_indicators.CCI_14;
        const obv = forward_indicators.OBV;
        const wr1 = forward_indicators.WR1;
        const wr2 = forward_indicators.WR2;
        
        return `
            <div class="row">
                ${rsi !== null && rsi !== undefined ? `
                    <div class="col-6 mb-2">
                        <small class="text-muted">RSI</small>
                        <div class="badge ${rsi > 70 ? 'bg-danger' : (rsi < 30 ? 'bg-success' : 'bg-light text-dark')}">
                            ${rsi.toFixed(1)}
                            ${rsi > 70 ? 'è¶…ä¹°' : (rsi < 30 ? 'è¶…å–' : 'æ­£å¸¸')}
                        </div>
                    </div>
                ` : ''}
                ${kdj_k !== null && kdj_k !== undefined ? `
                    <div class="col-6 mb-2">
                        <small class="text-muted">KDJ</small>
                        <div class="badge ${kdj_j > 100 ? 'bg-danger' : (kdj_j < 0 ? 'bg-success' : 'bg-light text-dark')}">
                            K:${kdj_k.toFixed(1)} D:${kdj_d.toFixed(1)} J:${kdj_j.toFixed(1)}
                            ${kdj_j > 100 ? 'è¶…ä¹°' : (kdj_j < 0 ? 'è¶…å–' : 'æ­£å¸¸')}
                        </div>
                    </div>
                ` : ''}
                ${cci !== null && cci !== undefined ? `
                    <div class="col-6 mb-2">
                        <small class="text-muted">CCI</small>
                        <div class="badge ${cci > 100 ? 'bg-danger' : (cci < -100 ? 'bg-success' : 'bg-light text-dark')}">
                            ${cci.toFixed(1)}
                            ${cci > 100 ? 'è¶…ä¹°' : (cci < -100 ? 'è¶…å–' : 'æ­£å¸¸')}
                        </div>
                    </div>
                ` : ''}
                ${obv !== null && obv !== undefined ? `
                    <div class="col-6 mb-2">
                        <small class="text-muted">OBV</small>
                        <div class="badge ${obv > 0 ? 'bg-success' : (obv < 0 ? 'bg-danger' : 'bg-light text-dark')}">
                            ${obv > 0 ? 'èµ„é‡‘æµå…¥' : (obv < 0 ? 'èµ„é‡‘æµå‡º' : 'èµ„é‡‘æŒå¹³')}
                        </div>
                    </div>
                ` : ''}
                ${wr1 !== null && wr1 !== undefined ? `
                    <div class="col-6 mb-2">
                        <small class="text-muted">å¨å»‰æŒ‡æ ‡(WR1/WR2)</small>
                        <div class="d-flex gap-1">
                            <div class="badge ${wr1 > 80 ? 'bg-danger' : (wr1 < 20 ? 'bg-success' : 'bg-light text-dark')}">
                                WR1: ${wr1.toFixed(1)}
                            </div>
                            <div class="badge ${wr2 > 80 ? 'bg-danger' : (wr2 < 20 ? 'bg-success' : 'bg-light text-dark')}">
                                WR2: ${wr2.toFixed(1)}
                            </div>
                        </div>
                        <small class="text-muted mt-1" style="font-size: 0.7rem;">
                            ${wr1 > 80 || wr2 > 80 ? 'è¶…å–(åå¼¹)' : (wr1 < 20 || wr2 < 20 ? 'è¶…ä¹°(å›è°ƒ)' : 'æ­£å¸¸åŒºé—´')}
                        </small>
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    // ç”Ÿæˆä»·æ ¼é¢„æµ‹HTML - å®Œå…¨AIé©±åŠ¨ï¼Œæ²¡æœ‰ç®—æ³•é¢„æµ‹å›é€€
function generatePredictionHTML(prediction_data, ai_signal, ai_confidence, ai_detailed_probability, ai_pred_1d, ai_pred_3d) {
        let html = '';

        // åªä½¿ç”¨ AI è®¡ç®—çš„é¢„æµ‹æ•°æ®
        const hasAIData = ai_detailed_probability &&
                        ai_detailed_probability.up !== undefined &&
                        ai_detailed_probability.down !== undefined &&
                        ai_detailed_probability.sideways !== undefined;

        if (hasAIData) {
            // AI é©±åŠ¨çš„é¢„æµ‹
            html += `
                <div class="mb-2">
                    <small class="text-muted">AIäº¤æ˜“ä¿¡å· <span class="badge bg-primary">AIé©±åŠ¨</span></small>
                    <div class="d-flex align-items-center">
                        <span class="badge ${getSignalBadgeClass(ai_signal || 'æŒæœ‰')} me-2">${ai_signal || 'æŒæœ‰'}</span>
                        <span class="badge bg-info">ç½®ä¿¡åº¦ ${ai_confidence || 50}%</span>
                    </div>
                </div>

                <div class="mb-2">
                    <small class="text-muted fw-bold">AI è®¡ç®—çš„è¶‹åŠ¿æ¦‚ç‡</small>
                    <div>
                        <span class="text-success">ä¸Šæ¶¨ ${ai_detailed_probability.up}%</span> |
                        <span class="text-danger">ä¸‹è·Œ ${ai_detailed_probability.down}%</span> |
                        <span class="text-secondary">æ¨ªç›˜ ${ai_detailed_probability.sideways}%</span>
                    </div>
                </div>

                ${ai_pred_1d && (ai_pred_1d.trend || ai_pred_1d.target) ? `
                    <div class="mb-3">
                        <small class="text-muted d-block mb-1">ğŸ“ˆ AI 1æ—¥é¢„æµ‹</small>
                        <div class="d-flex align-items-center">
                            <div class="badge ${ai_pred_1d.trend && (ai_pred_1d.trend.includes('ä¸Šæ¶¨') || ai_pred_1d.trend.includes('çœ‹å¤š')) ? 'bg-success' : (ai_pred_1d.trend && ai_pred_1d.trend.includes('ä¸‹è·Œ') ? 'bg-danger' : 'bg-light text-dark border')}">
                                ${ai_pred_1d.trend || 'é¢„æµ‹'}è‡³${ai_pred_1d.target || 'N/A'}
                            </div>
                            <div class="ms-2 d-flex align-items-center">
                                <span class="text-muted small me-1">ç½®ä¿¡åº¦:</span>
                                <span class="badge ${(ai_pred_1d.confidence || 0) >= 60 ? 'bg-info' : ((ai_pred_1d.confidence || 0) >= 40 ? 'bg-secondary' : 'bg-light text-dark')}">
                                    ${ai_pred_1d.confidence || 50}%
                                </span>
                            </div>
                        </div>
                    </div>
                ` : ''}

                ${ai_pred_3d && (ai_pred_3d.trend || ai_pred_3d.target) ? `
                    <div class="mb-3">
                        <small class="text-muted d-block mb-1">ğŸ“Š AI 3æ—¥é¢„æµ‹</small>
                        <div class="d-flex align-items-center">
                            <div class="badge ${ai_pred_3d.trend && (ai_pred_3d.trend.includes('ä¸Šæ¶¨') || ai_pred_3d.trend.includes('çœ‹å¤š')) ? 'bg-success' : (ai_pred_3d.trend && ai_pred_3d.trend.includes('ä¸‹è·Œ') ? 'bg-danger' : 'bg-light text-dark border')}">
                                ${ai_pred_3d.trend || 'é¢„æµ‹'}è‡³${ai_pred_3d.target || 'N/A'}
                            </div>
                            <div class="ms-2 d-flex align-items-center">
                                <span class="text-muted small me-1">ç½®ä¿¡åº¦:</span>
                                <span class="badge ${(ai_pred_3d.confidence || 0) >= 60 ? 'bg-info' : ((ai_pred_3d.confidence || 0) >= 40 ? 'bg-secondary' : 'bg-light text-dark')}">
                                    ${ai_pred_3d.confidence || 50}%
                                </span>
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
        } else {
            // æ— AIé¢„æµ‹æ•°æ®
            return '<span class="text-muted">AIé¢„æµ‹æ•°æ®æ­£åœ¨è®¡ç®—ä¸­...</span>';
        }

        return html;
    }

    // ç”Ÿæˆé¢„è­¦HTML
    function generateAlertHTML(alert_data) {
        if (!alert_data || !alert_data.alerts || alert_data.alerts.length === 0) {
            return '<span class="text-muted">æ— é¢„è­¦</span>';
        }
        
        const overall_risk = alert_data.overall_risk || 'low';
        const alert_count = alert_data.alert_count || {};
        const alerts = alert_data.alerts || [];
        
        const riskStyles = {
            'high': { badge: 'bg-danger', icon: 'fa-exclamation-circle', text: 'é«˜é£é™©' },
            'medium': { badge: 'bg-warning', icon: 'fa-exclamation-triangle', text: 'ä¸­é£é™©' },
            'low': { badge: 'bg-info', icon: 'fa-info-circle', text: 'ä½é£é™©' }
        };
        
        const riskStyle = riskStyles[overall_risk] || riskStyles['low'];
        
        return `
            <div class="alert ${riskStyle.badge} mb-2">
                <div class="d-flex align-items-center mb-2">
                    <i class="fas ${riskStyle.icon} me-2"></i>
                    <strong>æ•´ä½“é£é™©ï¼š${riskStyle.text}</strong>
                </div>
                <div class="small mb-2">
                    é¢„è­¦æ•°é‡ï¼š<span class="badge bg-danger mx-1">${alert_count.high || 0}é«˜é£é™©</span>
                    <span class="badge bg-warning mx-1">${alert_count.medium || 0}ä¸­é£é™©</span>
                    <span class="badge bg-info mx-1">${alert_count.low || 0}ä½é£é™©</span>
                </div>
                ${alerts.length > 0 ? `
                    <div class="small">
                        <strong>å…³é”®é¢„è­¦ï¼š</strong>
                        <ul class="mb-0 mt-1 ps-3">
                            ${alerts.slice(0, 3).map(alert => `<li>${alert.message}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            </div>
        `;
    }

    // ç”ŸæˆAIåˆ†æç»“æœHTML
    function generateAIResults(data, showDebug = false) {
        if (!data || data.length === 0) {
            return '<div class="text-center py-4"><i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i><p>æš‚æ— åˆ†ææ•°æ®</p></div>';
        }

        let html = '<div class="row">';

        data.forEach((item, index) => {
            const rank = index + 1;
            const signal = item.ai_signal || 'æŒæœ‰';
            const confidence = item.ai_confidence || 50;

            html += `
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h5 class="card-title mb-1">
                                        <span class="badge bg-secondary me-2">#${rank}</span>
                                        ${item.name || 'æœªçŸ¥'}
                                    </h5>
                                    <p class="text-muted mb-0">
                                        <code>${item.code || 'N/A'}</code>
                                    </p>
                                </div>
                                <div>
                                    <span class="badge ${getSignalBadgeClass(signal)} me-1">${signal}</span>
                                    <span class="badge bg-info">ç½®ä¿¡åº¦ ${confidence}%</span>
                                </div>
                            </div>

                            <div class="mb-3">
                                <small class="text-muted">äº¤æ˜“å»ºè®®</small>
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted d-block">æ¶¨è·Œæ¦‚ç‡</small>
                                        <strong>${item.ai_probability || 'æœªçŸ¥'}</strong>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted d-block">æ”¯æ’‘ä½</small>
                                        <strong>${item.ai_support || 'æœªçŸ¥'}</strong>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted d-block">é˜»åŠ›ä½</small>
                                        <strong>${item.ai_resistance || 'æœªçŸ¥'}</strong>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted d-block">ç›®æ ‡ä»·</small>
                                        <strong class="text-success">${item.ai_target || 'æœªçŸ¥'}</strong>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted d-block">æ­¢æŸä»·</small>
                                        <strong class="text-danger">${item.ai_stop_loss || 'æœªçŸ¥'}</strong>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <small class="text-muted">AIç‚¹è¯„</small>
                                <p class="small">
                                    ${item.ai_comment ?
                                        (item.ai_comment.includes('LLMåˆ†ææœåŠ¡å¼‚å¸¸') || item.ai_comment.includes('AIåˆ†ææœåŠ¡') ?
                                            `<span class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>${item.ai_comment}</span>` :
                                            item.ai_comment
                                        ) :
                                        'æš‚æ— ç‚¹è¯„'
                                    }
                                </p>
                            </div>
                            
                             ${!item.ai_signal && item.signal_data ? `
                                <div class="mb-3">
                                    <small class="text-muted">ä¹°å–ä¿¡å·</small>
                                    ${generateSignalHTML(item.signal_data)}
                                </div>
                             ` : ''}
                             
                             ${item.forward_indicators ? `
                                <div class="mb-3">
                                    <small class="text-muted">å‰ç»æ€§æŒ‡æ ‡</small>
                                    ${generateForwardIndicatorsHTML(item.forward_indicators)}
                                </div>
                             ` : ''}
                             
                             ${(item.ai_detailed_probability || item.ai_pred_1d || item.ai_pred_3d) ? `
                                <div class="mb-3">
                                    <small class="text-muted">ä»·æ ¼é¢„æµ‹</small>
                                    ${generatePredictionHTML(
                                        null,  // ä¸ä½¿ç”¨ç®—æ³•é¢„æµ‹æ•°æ®
                                        item.ai_signal,
                                        item.ai_confidence,
                                        item.ai_detailed_probability || {},
                                        item.ai_pred_1d || {},
                                        item.ai_pred_3d || {}
                                    )}
                                </div>
                             ` : ''}
                             
                             ${item.alert_data ? `
                                <div class="mb-3">
                                    <small class="text-muted">é£é™©é¢„è­¦</small>
                                    ${generateAlertHTML(item.alert_data)}
                                </div>
                             ` : ''}
                            
                            <div class="mb-3">
                                <small class="text-muted">æ—¥çº¿è¶‹åŠ¿</small>
                                <p class="mb-0">
                                    <span class="badge ${getStatusBadgeClass(item.daily_trend_status)}">
                                        ${item.daily_trend_status || 'æœªçŸ¥çŠ¶æ€'}
                                    </span>
                                </p>
                            </div>
                            
                            ${item.analysis_points && item.analysis_points.length > 0 ? `
                                <div>
                                    <small class="text-muted">æŠ€æœ¯ä¿¡å·</small>
                                    <div class="mt-1">
                                        ${item.analysis_points.map(point => 
                                            `<span class="badge bg-light text-dark me-1 mb-1">${point}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${item.technical_indicators_summary && item.technical_indicators_summary.length > 0 ? `
                                <div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <small class="text-muted">æŠ€æœ¯æŒ‡æ ‡</small>
                                        ${item.technical_indicators_summary.length > 3 ? 
                                            `<button class="btn btn-sm btn-outline-primary" onclick="toggleTechnicalIndicators(${index})">
                                                <i class="fas fa-eye me-1"></i>æŸ¥çœ‹è¯¦æƒ…
                                            </button>` : ''}
                                    </div>
                                    <div class="mt-1 small">
                                        <div id="indicators-${index}-summary">
                                            ${item.technical_indicators_summary.slice(0, 3).map(indicator => 
                                                `<div class="mb-1">â€¢ ${indicator}</div>`
                                            ).join('')}
                                            ${item.technical_indicators_summary.length > 3 ? 
                                                `<div class="text-muted">...è¿˜æœ‰${item.technical_indicators_summary.length - 3}ä¸ªæŒ‡æ ‡</div>` : ''}
                                        </div>
                                        <div id="indicators-${index}-full" style="display: none;">
                                            ${item.technical_indicators_summary.map(indicator => 
                                                `<div class="mb-1">â€¢ ${indicator}</div>`
                                            ).join('')}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        return html;
    }

    // ç”Ÿæˆæ•°æ®æŒ‡æ ‡ç»“æœHTML
    function generateDebugResults(data) {
        if (!data || data.length === 0) {
            return '<div class="text-center py-4"><i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i><p>æš‚æ— æ•°æ®æŒ‡æ ‡</p></div>';
        }
        
        let html = '<div class="row">';
        
        data.forEach((item, index) => {
            html += `
                <div class="col-12 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <h5>${item.name || 'æœªçŸ¥'}</h5>
                                    <p class="text-muted mb-1"><code>${item.code || 'N/A'}</code></p>
                                    <p class="mb-1">æœ€æ–°ä»·ï¼š<strong>${item.price || 'N/A'}</strong></p>
                                    <p class="mb-0">
                                        æ¶¨è·Œå¹…ï¼š
                                        <span class="${(item.æ¶¨è·Œå¹… || 0) >= 0 ? 'text-success' : 'text-danger'}">
                                            ${(item.æ¶¨è·Œå¹… || 0) >= 0 ? '+' : ''}${(item.æ¶¨è·Œå¹… || 0).toFixed(2)}%
                                        </span>
                                    </p>
                                </div>
                                
                                <div class="col-md-3">
                                    <h6>æ—¥çº¿è¶‹åŠ¿</h6>
                                    <p class="mb-0">${item.daily_trend_status || 'æœªçŸ¥'}</p>
                                </div>
                                
                                <div class="col-md-3">
                                    <h6>ç›˜ä¸­ä¿¡å·</h6>
                                    ${item.intraday_signals && item.intraday_signals.length > 0 ? 
                                        item.intraday_signals.map(signal => 
                                            `<span class="badge bg-info me-1 mb-1">${signal}</span>`
                                        ).join('') : 
                                        '<span class="text-muted">æ— ç‰¹æ®Šä¿¡å·</span>'
                                    }
                                </div>
                                
                                <div class="col-md-3">
                                    <h6>æŠ€æœ¯æŒ‡æ ‡</h6>
                                    ${item.technical_indicators_summary && item.technical_indicators_summary.length > 0 ? 
                                        `<div class="small">${item.technical_indicators_summary.map(indicator => 
                                            `<div class="mb-1">${indicator}</div>`
                                        ).join('')}</div>` : 
                                        '<span class="text-muted">æ•°æ®ä¸è¶³</span>'
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        return html;
    }

    // æ›´æ–°æœ€è¿‘åˆ†æ
    function updateRecentAnalysis(type, timestamp, count) {
        const recentAnalysis = document.getElementById('recentAnalysis');
        const typeNames = {
            'etf': 'ETFåˆ†æ',
            'stock': 'è‚¡ç¥¨åˆ†æ',
            'etf_debug': 'ETFæ•°æ®æŒ‡æ ‡',
            'stock_debug': 'è‚¡ç¥¨æ•°æ®æŒ‡æ ‡'
        };
        
        const html = `
            <div class="border rounded p-3">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${typeNames[type] || type}</h6>
                        <small class="text-muted d-block">
                            <i class="fas fa-clock me-1"></i>${formatDateTime(timestamp)}
                        </small>
                        <small class="text-muted">
                            <i class="fas fa-list me-1"></i>åˆ†æäº† ${count} ä¸ªæ ‡çš„
                        </small>
                    </div>
                    <div class="ms-2 flex-shrink-0">
                        <button class="btn btn-sm btn-outline-primary" onclick="showCurrentResults()">
                            <i class="fas fa-eye me-1"></i>æŸ¥çœ‹
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        recentAnalysis.innerHTML = html;
    }

    // åŠ è½½æœ€è¿‘åˆ†æè®°å½•
    function loadRecentAnalysis() {
        fetch('/api/analysis-history?limit=1')
            .then(response => {
                // æ£€æŸ¥å“åº”çŠ¶æ€
                if (response.status === 401 || response.status === 403) {
                    // æœªç™»å½•çŠ¶æ€ï¼Œä¸æ˜¾ç¤ºæœ€è¿‘åˆ†æ
                    const recentAnalysis = document.getElementById('recentAnalysis');
                    recentAnalysis.innerHTML = `
                        <div class="text-center py-3">
                            <i class="fas fa-user-lock fa-2x text-muted mb-2"></i>
                            <p class="text-muted">è¯·å…ˆç™»å½•æŸ¥çœ‹åˆ†æå†å²</p>
                        </div>
                    `;
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // æ£€æŸ¥å“åº”å†…å®¹ç±»å‹
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    // å¦‚æœè¿”å›çš„ä¸æ˜¯JSONï¼ˆå¯èƒ½æ˜¯HTMLç™»å½•é¡µé¢ï¼‰ï¼Œè¯´æ˜æœªç™»å½•
                    const recentAnalysis = document.getElementById('recentAnalysis');
                    recentAnalysis.innerHTML = `
                        <div class="text-center py-3">
                            <i class="fas fa-user-lock fa-2x text-muted mb-2"></i>
                            <p class="text-muted">è¯·å…ˆç™»å½•æŸ¥çœ‹åˆ†æå†å²</p>
                        </div>
                    `;
                    return;
                }
                
                return response.json();
            })
            .then(data => {
                if (!data) return; // å¦‚æœä¸Šé¢å·²ç»å¤„ç†äº†æœªç™»å½•æƒ…å†µ
                
                if (data.success && data.data && data.data.length > 0) {
                    const latestRecord = data.data[0];
                    displayRecentAnalysis(latestRecord);
                    // è®°å½•æ—¶é—´æˆ³ï¼Œç”¨äºåç»­æ¯”è¾ƒ
                    lastAnalysisTimestamp = latestRecord.created_at;
                } else {
                    // æ²¡æœ‰å†å²è®°å½•ï¼Œæ˜¾ç¤ºé»˜è®¤æç¤º
                    const recentAnalysis = document.getElementById('recentAnalysis');
                    recentAnalysis.innerHTML = `
                        <div class="text-center py-3">
                            <i class="fas fa-clock fa-2x text-muted mb-2"></i>
                            <p class="text-muted">æš‚æ— åˆ†æè®°å½•ï¼Œå¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡åˆ†æå§ï¼</p>
                        </div>
                    `;
                    lastAnalysisTimestamp = null;
                }
            })
            .catch(error => {
                console.error('åŠ è½½æœ€è¿‘åˆ†æå¤±è´¥:', error);
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                const recentAnalysis = document.getElementById('recentAnalysis');
                recentAnalysis.innerHTML = `
                    <div class="text-center py-3">
                        <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                        <p class="text-muted">åŠ è½½åˆ†æå†å²å¤±è´¥: ${error.message}</p>
                        <button class="btn btn-sm btn-outline-primary" onclick="loadRecentAnalysis()">é‡è¯•</button>
                    </div>
                `;
            });
    }

    // æ˜¾ç¤ºæœ€è¿‘åˆ†æè®°å½•
    function displayRecentAnalysis(record) {
        const recentAnalysis = document.getElementById('recentAnalysis');
        
        const typeName = getTypeDisplayName(record.analysis_type);
        const badgeClass = getTypeBadgeClass(record.analysis_type);
        
        // è®¡ç®—æ ‡çš„æ•°é‡ï¼ˆä»resultså­—æ®µè§£æï¼‰
        let count = 0;
        try {
            if (record.results) {
                const results = typeof record.results === 'string' ? JSON.parse(record.results) : record.results;
                count = results ? results.length : 0;
            }
        } catch (e) {
            count = 0;
        }
        
        const html = `
            <div class="border rounded p-3">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1 flex-wrap">
                            <h6 class="mb-0 me-2">${typeName}</h6>
                            <span class="badge ${badgeClass}">${typeName}</span>
                        </div>
                        <small class="text-muted d-block">
                            <i class="fas fa-clock me-1"></i>${formatDateTime(record.created_at)}
                        </small>
                        <small class="text-muted">
                            <i class="fas fa-list me-1"></i>åˆ†æäº† ${count} ä¸ªæ ‡çš„
                        </small>
                    </div>
                    <div class="ms-2 flex-shrink-0">
                        <button class="btn btn-sm btn-outline-primary" onclick="showRecentAnalysisDetail(${record.id})">
                            <i class="fas fa-eye me-1"></i>æŸ¥çœ‹
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        recentAnalysis.innerHTML = html;
    }

    // æ˜¾ç¤ºæœ€è¿‘åˆ†æè¯¦æƒ…
    function showRecentAnalysisDetail(recordId) {
        // è·å–åˆ†æè¯¦æƒ…å¹¶æ˜¾ç¤ºåœ¨æ¨¡æ€æ¡†ä¸­
        fetch(`/api/history/${recordId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    displayHistoryDetail(data.data);
                } else {
                    alert('è·å–åˆ†æè¯¦æƒ…å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('è·å–åˆ†æè¯¦æƒ…å¤±è´¥:', error);
                alert('è·å–åˆ†æè¯¦æƒ…å¤±è´¥');
            });
    }

    // æ˜¾ç¤ºå†å²è¯¦æƒ…ï¼ˆå¤ç”¨å†å²é¡µé¢çš„é€»è¾‘ï¼‰
    function displayHistoryDetail(record) {
        // è§£æç»“æœæ•°æ®
        let results = [];
        try {
            if (record.results) {
                results = typeof record.results === 'string' ? JSON.parse(record.results) : record.results;
            }
        } catch (e) {
            console.error('è§£æresultså­—æ®µå¤±è´¥:', e);
        }

        // æ„å»ºè¯¦æƒ…HTML
        let detailHtml = `
            <div class="modal fade" id="historyDetailModal" tabindex="-1">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-chart-line me-2"></i>åˆ†æè¯¦æƒ…
                                <span class="badge bg-primary ms-2">${record.analysis_type}</span>
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>åˆ†ææ—¶é—´:</strong> ${formatDateTime(record.created_at)}
                                </div>
                                <div class="col-md-6">
                                    <strong>åˆ†ææ ‡çš„æ•°é‡:</strong> ${results.length} ä¸ª
                                </div>
                            </div>
        `;

        // æ·»åŠ æ¯ä¸ªæ ‡çš„çš„è¯¦ç»†ä¿¡æ¯
        if (results && results.length > 0) {
            detailHtml += '<div class="accordion" id="analysisAccordion">';
            
            results.forEach((item, index) => {
                const dailyTrendStatus = item.daily_trend_status || 'æœªçŸ¥çŠ¶æ€';
                const aiSignal = item.ai_signal || 'æŒæœ‰';
                const aiConfidence = item.ai_confidence || 50;
                const aiComment = item.ai_comment || 'æš‚æ— AIåˆ†æ';

                detailHtml += `
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                                <div class="d-flex justify-content-between w-100 me-3">
                                    <div>
                                        <strong>${item.name}</strong> (${item.code})
                                    </div>
                                    <div class="text-end">
                                        <span class="badge me-2 ${(item.æ¶¨è·Œå¹… || 0) > 0 ? 'bg-danger text-white' : ((item.æ¶¨è·Œå¹… || 0) < 0 ? 'bg-success text-white' : 'bg-warning text-dark')}">
                                            ${(item.æ¶¨è·Œå¹… || 0) !== null && (item.æ¶¨è·Œå¹… || 0) !== undefined ?
                                                ((item.æ¶¨è·Œå¹… || 0) > 0 ? '+' : '') + (item.æ¶¨è·Œå¹… || 0).toFixed(2) + '%' :
                                                'N/A'
                                            }
                                        </span>
                                        <span class="badge ${getSignalBadgeClass(aiSignal)} me-2">${aiSignal}</span>
                                        <span class="badge bg-info me-2">ç½®ä¿¡åº¦ ${aiConfidence}%</span>
                                        <span class="badge ${getTrendBadgeClass(dailyTrendStatus)}">${dailyTrendStatus}</span>
                                    </div>
                                </div>
                            </button>
                        </h2>
                        <div id="collapse${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                             data-bs-parent="#analysisAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>AIæŠ•èµ„å»ºè®®</h6>
                                        <div class="ai-comment mb-3">
                                            ${aiComment.includes('LLMåˆ†ææœåŠ¡å¼‚å¸¸') || aiComment.includes('AIåˆ†ææœåŠ¡') ?
                                                `<span class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>${aiComment}</span>` :
                                                aiComment
                                            }
                                        </div>
                                        
                                        ${item.forward_indicators ? `
                                            <h6 class="mt-3">å‰ç»æ€§æŒ‡æ ‡</h6>
                                            ${generateForwardIndicatorsHTML(item.forward_indicators)}
                                        ` : ''}
                                        
                                        ${(item.ai_detailed_probability || item.ai_pred_1d || item.ai_pred_3d) ? `
                                            <h6 class="mt-3">ä»·æ ¼é¢„æµ‹</h6>
                                            ${generatePredictionHTML(
                                                null,  // ä¸ä½¿ç”¨ç®—æ³•é¢„æµ‹æ•°æ®
                                                item.ai_signal,
                                                item.ai_confidence,
                                                item.ai_detailed_probability || {},
                                                item.ai_pred_1d || {},
                                                item.ai_pred_3d || {}
                                            )}
                                        ` : '<p class="text-muted mt-3">AIé¢„æµ‹æ•°æ®è®¡ç®—ä¸­...</p>'}
                                        
                                        ${item.alert_data ? `
                                            <h6 class="mt-3">é£é™©é¢„è­¦</h6>
                                            ${generateAlertHTML(item.alert_data)}
                                        ` : ''}
                                    </div>
                                    <div class="col-md-6">
                                        <h6>æŠ€æœ¯æŒ‡æ ‡åˆ†æ</h6>
                                        <div class="technical-analysis mb-3">
                                            ${item.technical_indicators_summary && item.technical_indicators_summary.length > 0 ? 
                                                item.technical_indicators_summary.map(indicator => `<div class="mb-1">â€¢ ${indicator}</div>`).join('') : 
                                                'æš‚æ— æŠ€æœ¯åˆ†æ'
                                            }
                                        </div>
                                        
                                        ${item.analysis_points && item.analysis_points.length > 0 ? `
                                            <h6 class="mt-3">æŠ€æœ¯ä¿¡å·</h6>
                                            <div class="mt-1 mb-3">
                                                ${item.analysis_points.map(point => 
                                                    `<span class="badge bg-light text-dark me-1 mb-1">${point}</span>`
                                                ).join('')}
                                            </div>
                                        ` : ''}
                                        
                                        <h6 class="mt-3">æ—¥çº¿è¶‹åŠ¿</h6>
                                        <p class="mb-0">
                                            <span class="badge ${getStatusBadgeClass(dailyTrendStatus)}">
                                                ${dailyTrendStatus}
                                            </span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            detailHtml += '</div>';
        }

        detailHtml += `
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†
        const existingModal = document.getElementById('historyDetailModal');
        if (existingModal) {
            existingModal.remove();
        }

        // æ·»åŠ æ–°çš„æ¨¡æ€æ¡†åˆ°é¡µé¢
        document.body.insertAdjacentHTML('beforeend', detailHtml);

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        const modal = new bootstrap.Modal(document.getElementById('historyDetailModal'));
        modal.show();

        // æ¨¡æ€æ¡†å…³é—­æ—¶ç§»é™¤DOMå…ƒç´ 
        document.getElementById('historyDetailModal').addEventListener('hidden.bs.modal', function() {
            this.remove();
        });
    }

    // æ ¹æ®è¶‹åŠ¿çŠ¶æ€è·å–å¾½ç« æ ·å¼
    function getTrendBadgeClass(status) {
        if (status.includes('å¼ºåŠ¿ä¸Šå‡') || status.includes('ä¸Šå‡')) {
            return 'bg-success';
        } else if (status.includes('å¼±åŠ¿ä¸‹é™') || status.includes('ä¸‹é™')) {
            return 'bg-danger';
        } else if (status.includes('éœ‡è¡')) {
            return 'bg-warning';
        } else {
            return 'bg-secondary';
        }
    }

    // å¯åŠ¨æœ€è¿‘åˆ†æè½®è¯¢
    function startRecentAnalysisPolling() {
        // å¦‚æœå·²ç»æœ‰å®šæ—¶å™¨åœ¨è¿è¡Œï¼Œå…ˆæ¸…é™¤
        if (recentAnalysisPollingTimer) {
            clearInterval(recentAnalysisPollingTimer);
        }
        
        // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦æœ‰æ–°çš„åˆ†æç»“æœ
        recentAnalysisPollingTimer = setInterval(() => {
            checkForNewAnalysis();
        }, 30000); // 30ç§’
    }
    

    // åœæ­¢æœ€è¿‘åˆ†æè½®è¯¢
    function stopRecentAnalysisPolling() {
        if (recentAnalysisPollingTimer) {
            clearInterval(recentAnalysisPollingTimer);
            recentAnalysisPollingTimer = null;
        }
    }

    // æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„åˆ†æç»“æœ
    function checkForNewAnalysis() {
        fetch('/api/analysis-history?limit=1')
            .then(response => {
                // æ£€æŸ¥å“åº”çŠ¶æ€
                if (response.status === 401 || response.status === 403) {
                    // æœªç™»å½•çŠ¶æ€ï¼Œåœæ­¢è½®è¯¢
                    stopRecentAnalysisPolling();
                    return;
                }
                
                // æ£€æŸ¥å“åº”å†…å®¹ç±»å‹
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    // å¦‚æœè¿”å›çš„ä¸æ˜¯JSONï¼Œè¯´æ˜æœªç™»å½•ï¼Œåœæ­¢è½®è¯¢
                    stopRecentAnalysisPolling();
                    return;
                }
                
                return response.json();
            })
            .then(data => {
                if (!data) return; // å¦‚æœä¸Šé¢å·²ç»å¤„ç†äº†æœªç™»å½•æƒ…å†µ
                
                if (data.success && data.data.length > 0) {
                    const latestRecord = data.data[0];
                    const latestTimestamp = latestRecord.created_at;
                    
                    // å¦‚æœæœ‰æ–°çš„åˆ†æç»“æœï¼ˆæ—¶é—´æˆ³ä¸åŒï¼‰ï¼Œæ›´æ–°æ˜¾ç¤º
                    if (lastAnalysisTimestamp !== latestTimestamp) {
                        displayRecentAnalysis(latestRecord);
                        lastAnalysisTimestamp = latestTimestamp;
                    }
                }
            })
            .catch(error => {
                console.error('æ£€æŸ¥æ–°åˆ†æç»“æœå¤±è´¥:', error);
                // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯æˆ–è§£æé”™è¯¯ï¼Œå¯èƒ½æ˜¯æœªç™»å½•ï¼Œåœæ­¢è½®è¯¢
                if (error.message.includes('Unexpected token') || error.message.includes('401') || error.message.includes('403')) {
                    stopRecentAnalysisPolling();
                }
            });
    }

    // è·å–ç±»å‹æ˜¾ç¤ºåç§°
    function getTypeDisplayName(analysisType) {
        const typeNames = {
            'etf': 'ETFåˆ†æ',
            'stock': 'è‚¡ç¥¨åˆ†æ',
            'etf_debug': 'ETFæ•°æ®æŒ‡æ ‡',
            'stock_debug': 'è‚¡ç¥¨æ•°æ®æŒ‡æ ‡'
        };
        return typeNames[analysisType] || analysisType;
    }

    // è·å–ç±»å‹å¾½ç« æ ·å¼
    function getTypeBadgeClass(analysisType) {
        if (analysisType.includes('etf')) {
            return 'bg-primary';
        } else if (analysisType.includes('stock')) {
            return 'bg-success';
        }
        return 'bg-secondary';
    }

    // æ˜¾ç¤ºå½“å‰ç»“æœ
    function showCurrentResults() {
        if (currentAnalysisData) {
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }
    }

    // å¯¼å‡ºç»“æœ
    function exportResults() {
        if (!currentAnalysisData) {
            showAlert('æš‚æ— æ•°æ®å¯å¯¼å‡º', 'warning');
            return;
        }
        
        const dataStr = JSON.stringify(currentAnalysisData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `analysis_results_${new Date().getTime()}.json`;
        link.click();
        URL.revokeObjectURL(url);
        
        showAlert('åˆ†æç»“æœå·²å¯¼å‡º', 'success');
    }

    // è·å–çŠ¶æ€å¾½ç« æ ·å¼ç±»
    function getStatusBadgeClass(status) {
        if (!status) return 'bg-secondary';
        
        if (status.includes('å¼ºåŠ¿ä¸Šå‡') || status.includes('ä¸Šå‡è¶‹åŠ¿')) {
            return 'bg-success';
        } else if (status.includes('ä¸‹é™è¶‹åŠ¿') || status.includes('å¼±åŠ¿')) {
            return 'bg-danger';
        } else if (status.includes('éœ‡è¡') || status.includes('ä¸­æ€§')) {
            return 'bg-warning text-dark';
        } else if (status.includes('æ•°æ®ä¸è¶³') || status.includes('æ•°æ®å¼‚å¸¸')) {
            return 'bg-info';
        } else if (status.includes('åˆ†æå¤±è´¥') || status.includes('é”™è¯¯')) {
            return 'bg-danger';
        } else {
            return 'bg-secondary';
        }
    }

    // æ˜¾ç¤ºAIåˆ†æç»“æœå¼¹çª—
    function showAIAnalysisModal(data, type) {
        const modal = new bootstrap.Modal(document.getElementById('aiAnalysisModal'));
        const content = document.getElementById('aiAnalysisContent');
        
        // æ›´æ–°å¼¹çª—æ ‡é¢˜
        const title = document.getElementById('aiAnalysisModalLabel');
        const typeNames = {
            'etf': 'ETF AIåˆ†æç»“æœ',
            'stock': 'è‚¡ç¥¨AIåˆ†æç»“æœ'
        };
        title.innerHTML = `<i class="fas fa-robot me-2"></i>${typeNames[type] || 'AIåˆ†æç»“æœ'}`;
        
        // ç”ŸæˆAIåˆ†æå†…å®¹
        content.innerHTML = generateAIResults(data, type && type.includes('debug'));
        
        // æ˜¾ç¤ºå¼¹çª—
        modal.show();
    }

    // æ˜¾ç¤ºæ•°æ®æŒ‡æ ‡å¼¹çª—
    function showDataIndicatorsModal(data, type) {
        const modal = new bootstrap.Modal(document.getElementById('dataIndicatorsModal'));
        const content = document.getElementById('dataIndicatorsContent');
        
        // æ›´æ–°å¼¹çª—æ ‡é¢˜
        const title = document.getElementById('dataIndicatorsModalLabel');
        const typeNames = {
            'etf_debug': 'ETFæ•°æ®æŒ‡æ ‡åˆ†æ',
            'stock_debug': 'è‚¡ç¥¨æ•°æ®æŒ‡æ ‡åˆ†æ'
        };
        title.innerHTML = `<i class="fas fa-chart-bar me-2"></i>${typeNames[type] || 'æ•°æ®æŒ‡æ ‡åˆ†æ'}`;
        
        // ç”Ÿæˆæ•°æ®æŒ‡æ ‡å†…å®¹
        content.innerHTML = generateDataIndicatorsContent(data);
        
        // æ˜¾ç¤ºå¼¹çª—
        modal.show();
    }

    // ç”Ÿæˆæ•°æ®æŒ‡æ ‡å†…å®¹
    function generateDataIndicatorsContent(data) {
        if (!data || data.length === 0) {
            return '<div class="text-center py-4"><i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i><p>æš‚æ— æ•°æ®æŒ‡æ ‡</p></div>';
        }
        
        let html = '<div class="row">';
        
        data.forEach((item, index) => {
            html += `
                <div class="col-12 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <h5>${item.name || 'æœªçŸ¥'}</h5>
                                    <p class="text-muted mb-1"><code>${item.code || 'N/A'}</code></p>
                                    <p class="mb-1">æœ€æ–°ä»·ï¼š<strong>${item.price || 'N/A'}</strong></p>
                                    <p class="mb-0">
                                        æ¶¨è·Œå¹…ï¼š
                                        <span class="${(item.æ¶¨è·Œå¹… || 0) >= 0 ? 'text-success' : 'text-danger'}">
                                            ${(item.æ¶¨è·Œå¹… || 0) >= 0 ? '+' : ''}${(item.æ¶¨è·Œå¹… || 0).toFixed(2)}%
                                        </span>
                                    </p>
                                </div>
                                
                                <div class="col-md-3">
                                    <h6>æ—¥çº¿è¶‹åŠ¿</h6>
                                    <p class="mb-0">
                                        <span class="badge ${getStatusBadgeClass(item.daily_trend_status)}">
                                            ${item.daily_trend_status || 'æœªçŸ¥çŠ¶æ€'}
                                        </span>
                                    </p>
                                </div>
                                
                                <div class="col-md-3">
                                    <h6>ç›˜ä¸­ä¿¡å·</h6>
                                    ${item.intraday_signals && item.intraday_signals.length > 0 ? 
                                        item.intraday_signals.map(signal => 
                                            `<span class="badge bg-info me-1 mb-1">${signal}</span>`
                                        ).join('') : 
                                        '<span class="text-muted">æ— ç‰¹æ®Šä¿¡å·</span>'
                                    }
                                </div>
                                
                                <div class="col-md-3">
                                    <h6>æŠ€æœ¯æŒ‡æ ‡</h6>
                                    ${item.technical_indicators_summary && item.technical_indicators_summary.length > 0 ? 
                                        `<div class="small">${item.technical_indicators_summary.map(indicator => 
                                            `<div class="mb-1">${indicator}</div>`
                                        ).join('')}</div>` : 
                                        '<span class="text-muted">æ•°æ®ä¸è¶³</span>'
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        return html;
    }

    // å¯¼å‡ºAIåˆ†æç»“æœ
    function exportAIAnalysis() {
        if (!currentAnalysisData) {
            showAlert('æš‚æ— æ•°æ®å¯å¯¼å‡º', 'warning');
            return;
        }
        
        const dataStr = JSON.stringify(currentAnalysisData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `ai_analysis_${new Date().getTime()}.json`;
        link.click();
        URL.revokeObjectURL(url);
        
        showAlert('AIåˆ†æç»“æœå·²å¯¼å‡º', 'success');
    }

    // å¯¼å‡ºæ•°æ®æŒ‡æ ‡
    function exportDataIndicators() {
        if (!currentAnalysisData) {
            showAlert('æš‚æ— æ•°æ®å¯å¯¼å‡º', 'warning');
            return;
        }
        
        const dataStr = JSON.stringify(currentAnalysisData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `data_indicators_${new Date().getTime()}.json`;
        link.click();
        URL.revokeObjectURL(url);
        
        showAlert('æ•°æ®æŒ‡æ ‡å·²å¯¼å‡º', 'success');
    }

    // æ˜¾ç¤ºåŠ è½½å¼¹çª—
    function showLoadingModal(type) {
        const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
        const title = document.getElementById('loadingTitle');
        const description = document.getElementById('loadingDescription');
        
        if (type.includes('debug')) {
            title.textContent = 'æ•°æ®æŒ‡æ ‡è·å–ä¸­...';
            description.textContent = 'æ­£åœ¨è·å–å†å²æ•°æ®å¹¶è®¡ç®—æŠ€æœ¯æŒ‡æ ‡ï¼Œè¯·ç¨å€™';
        } else {
            title.textContent = 'AIåˆ†æè¿›è¡Œä¸­...';
            description.textContent = 'æ­£åœ¨è·å–æ•°æ®å¹¶è¿›è¡Œæ™ºèƒ½åˆ†æï¼Œè¯·ç¨å€™';
        }
        
        modal.show();
    }

    // éšè—åŠ è½½å¼¹çª—
    function hideLoadingModal() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
        if (modal) {
            modal.hide();
        }
    }

    // æ˜¾ç¤ºéœ€è¦ç™»å½•æç¤º
    function showLoginRequired() {
        const etfContainer = document.getElementById('etfPoolContainer');
        const stockContainer = document.getElementById('stockPoolContainer');
        if (etfContainer) {
            etfContainer.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-warning text-center">
                        <i class="fas fa-user-lock me-2"></i>
                        è¯·å…ˆ<a href="/login" class="alert-link">ç™»å½•</a>æŸ¥çœ‹æ‚¨çš„æ ‡çš„æ± 
                    </div>
                </div>
            `;
        }
        if (stockContainer) {
            stockContainer.innerHTML = '';
        }
    }

</script>

<style>
.score-badge {
    font-size: 1.5rem;
    font-weight: bold;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    min-width: 80px;
    text-align: center;
}

.score-badge.excellent { background-color: #d4edda; color: #155724; }
.score-badge.good { background-color: #cce5ff; color: #004085; }
.score-badge.average { background-color: #fff3cd; color: #856404; }
.score-badge.poor { background-color: #f8d7da; color: #721c24; }
.score-badge-data-missing { 
    background-color: #f8f9fa; 
    color: #6c757d; 
    border: 2px dashed #dee2e6;
    font-size: 1rem;
}
</style>
{% endblock %}
