{% extends "base.html" %}

{% block title %}分析历史 - AI量化投资分析平台{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0">
                        <i class="fas fa-history me-2"></i>分析历史
                    </h4>
                    <p class="text-muted mb-0 mt-2">查看过往的分析结果和记录</p>
                </div>
                <div>
                    <button class="btn btn-outline-secondary me-2" onclick="refreshHistory()">
                        <i class="fas fa-sync-alt me-1"></i>刷新
                    </button>
                    <button class="btn btn-outline-danger" onclick="clearHistory()" 
                            {% if not history %}disabled{% endif %}>
                        <i class="fas fa-trash me-1"></i>清空历史
                    </button>
                </div>
            </div>
            <div class="card-body">
                {% if history %}
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="searchInput" 
                                       placeholder="搜索分析记录...">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <select class="form-select" id="typeFilter">
                                <option value="">所有类型</option>
                                <option value="etf">ETF分析</option>
                                <option value="stock">股票分析</option>
                                <option value="etf_debug">ETF数据指标</option>
                                <option value="stock_debug">股票数据指标</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="historyList">
                        {% for record in history %}
                        <div class="history-item card mb-3" data-type="{{ record.analysis_type }}" 
                             data-date="{{ record.created_at }}">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <div class="d-flex align-items-start justify-content-between mb-2">
                                            <h6 class="mb-0">
                                                {% if record.analysis_type == 'etf' %}ETF AI分析报告
                                                {% elif record.analysis_type == 'stock' %}股票AI分析报告
                                                {% elif record.analysis_type == 'etf_debug' %}ETF数据指标分析报告
                                                {% elif record.analysis_type == 'stock_debug' %}股票数据指标分析报告
                                                {% endif %}
                                            </h6>
                                            <div class="text-end">
                                                {% if record.analysis_type == 'etf' %}
                                                    <i class="fas fa-chart-pie text-primary me-1"></i>
                                                    <span class="badge bg-primary">ETF分析</span>
                                                {% elif record.analysis_type == 'stock' %}
                                                    <i class="fas fa-chart-line text-success me-1"></i>
                                                    <span class="badge bg-success">股票分析</span>
                                                {% elif record.analysis_type == 'etf_debug' %}
                                                    <i class="fas fa-chart-bar text-warning me-1"></i>
                                                    <span class="badge bg-warning">ETF数据指标</span>
                                                {% elif record.analysis_type == 'stock_debug' %}
                                                    <i class="fas fa-chart-bar text-info me-1"></i>
                                                    <span class="badge bg-info">股票数据指标</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <p class="text-muted mb-1">
                                            <i class="fas fa-clock me-1"></i>
                                            <span class="time-display" data-timestamp="{{ record.created_at }}">加载中...</span>
                                        </p>
                                        <p class="text-muted mb-0 d-flex align-items-center justify-content-between">
                                            <span>
                                                <i class="fas fa-list me-1"></i>
                                                分析了 
                                                {% set results = record.results | from_json %}
                                                {{ results | length if results else 0 }} 个标的
                                            </span>
                                            {% if results and results | length > 0 %}
                                                <span class="text-end">
                                                    <i class="fas fa-chart-bar me-1 text-muted"></i>
                                                    <small class="text-muted">{{ results | length }} 个标的</small>
                                                </span>
                                            {% endif %}
                                        </p>
                                    </div>
                                    
                                    <div class="col-md-4 text-end">
                                        <button class="btn btn-sm btn-outline-primary me-1" 
                                                onclick="viewHistory({{ record.id }})">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary me-1" 
                                                onclick="downloadHistory({{ record.id }})">
                                            <i class="fas fa-download"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" 
                                                onclick="deleteHistory({{ record.id }})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- 分页 -->
                    <nav aria-label="历史记录分页" class="mt-4">
                        <ul class="pagination justify-content-center">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1">上一页</a>
                            </li>
                            <li class="page-item active">
                                <a class="page-link" href="#">1</a>
                            </li>
                            <li class="page-item disabled">
                                <a class="page-link" href="#">下一页</a>
                            </li>
                        </ul>
                    </nav>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-history fa-4x text-muted mb-3"></i>
                        <h5 class="text-muted">暂无分析历史</h5>
                        <p class="text-muted">开始您的第一次分析，记录将会显示在这里</p>
                        <a href="{{ url_for('analysis_page') }}" class="btn btn-primary">
                            <i class="fas fa-play me-1"></i>开始分析
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 查看详情模态框 -->
<div class="modal fade" id="historyDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-bar me-2"></i>分析详情
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="historyDetailContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    关闭
                </button>
                <button type="button" class="btn btn-primary" onclick="downloadCurrentHistory()">
                    <i class="fas fa-download me-1"></i>下载
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentHistoryData = null;

    function formatDateTime(timestamp) {
        if (!timestamp) return 'N/A';
        const date = new Date(timestamp);
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        });
    }

    // 获取类型显示名称
    function getTypeDisplayName(analysisType) {
        const typeNames = {
            'etf': 'ETF分析',
            'stock': '股票分析',
            'etf_debug': 'ETF数据指标',
            'stock_debug': '股票数据指标'
        };
        return typeNames[analysisType] || '未知类型';
    }

    // 获取类型徽章样式
    function getTypeBadgeClass(analysisType) {
        const typeClasses = {
            'etf': 'bg-primary',
            'stock': 'bg-success',
            'etf_debug': 'bg-warning',
            'stock_debug': 'bg-info'
        };
        return typeClasses[analysisType] || 'bg-secondary';
    }

    function getSignalBadgeClass(signal) {
        switch(signal) {
            case '强烈买入': return 'bg-success';
            case '买入': return 'bg-primary';
            case '持有': return 'bg-secondary';
            case '卖出': return 'bg-warning';
            case '强烈卖出': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }

    function getTrendBadgeClass(status) {
        if (status.includes('强势上升') || status.includes('上升')) {
            return 'bg-success';
        } else if (status.includes('弱势下降') || status.includes('下降')) {
            return 'bg-danger';
        } else if (status.includes('震荡')) {
            return 'bg-warning';
        } else {
            return 'bg-secondary';
        }
    }

    function getStatusBadgeClass(status) {
        if (status.includes('强势上升') || status.includes('上升')) {
            return 'bg-success';
        } else if (status.includes('弱势下降') || status.includes('下降')) {
            return 'bg-danger';
        } else if (status.includes('震荡')) {
            return 'bg-warning';
        } else {
            return 'bg-secondary';
        }
    }

    function generateForwardIndicatorsHTML(forward_indicators) {
        if (!forward_indicators) {
            return '<span class="text-muted">无数据</span>';
        }
        
        const rsi = forward_indicators.RSI_14;
        const kdj_k = forward_indicators.KDJ_K;
        const kdj_d = forward_indicators.KDJ_D;
        const kdj_j = forward_indicators.KDJ_J;
        const cci = forward_indicators.CCI_14;
        const obv = forward_indicators.OBV;
        const obv_change = forward_indicators.OBV_change;
        const wr1 = forward_indicators.WR1;
        const wr2 = forward_indicators.WR2;
        
        return `
            <div class="row">
                ${rsi !== null && rsi !== undefined ? `
                    <div class="col-6 mb-2">
                        <small class="text-muted">RSI</small>
                        <div class="badge ${rsi > 70 ? 'bg-danger' : (rsi < 30 ? 'bg-success' : 'bg-light text-dark')}">
                            ${rsi.toFixed(1)}
                            ${rsi > 70 ? '超买' : (rsi < 30 ? '超卖' : '正常')}
                        </div>
                    </div>
                ` : ''}
                ${kdj_k !== null && kdj_k !== undefined ? `
                    <div class="col-6 mb-2">
                        <small class="text-muted">KDJ (日线)</small>
                        <div class="badge ${kdj_j > 100 ? 'bg-danger' : (kdj_j < 0 ? 'bg-success' : 'bg-light text-dark')}">
                            K:${kdj_k.toFixed(1)} D:${kdj_d.toFixed(1)} J:${kdj_j.toFixed(1)}
                            ${kdj_j > 100 ? '超买' : (kdj_j < 0 ? '超卖' : '正常')}
                        </div>
                    </div>
                ` : ''}
                ${cci !== null && cci !== undefined ? `
                    <div class="col-6 mb-2">
                        <small class="text-muted">CCI</small>
                        <div class="badge ${cci > 100 ? 'bg-danger' : (cci < -100 ? 'bg-success' : 'bg-light text-dark')}">
                            ${cci.toFixed(1)}
                            ${cci > 100 ? '超买' : (cci < -100 ? '超卖' : '正常')}
                        </div>
                    </div>
                ` : ''}
                ${obv !== null && obv !== undefined && obv_change !== null && obv_change !== undefined ? `
                    <div class="col-6 mb-2">
                        <small class="text-muted">OBV</small>
                        <div class="badge ${obv_change > 0 ? 'bg-success' : (obv_change < 0 ? 'bg-danger' : 'bg-light text-dark')}">
                            ${obv_change > 0 ? '资金流入' : (obv_change < 0 ? '资金流出' : '资金持平')}
                        </div>
                        <small class="text-muted d-block mt-1" style="font-size: 0.7rem;">
                            变化: ${obv_change > 0 ? '+' : ''}${obv_change.toFixed(0)}
                        </small>
                    </div>
                ` : ''}
                ${wr1 !== null && wr1 !== undefined ? `
                    <div class="col-6 mb-2">
                        <small class="text-muted">威廉指标(WR1/WR2)</small>
                        <div class="d-flex gap-1">
                            <div class="badge ${wr1 > 80 ? 'bg-danger' : (wr1 < 20 ? 'bg-success' : 'bg-light text-dark')}">
                                WR1: ${wr1.toFixed(1)}
                            </div>
                            <div class="badge ${wr2 > 80 ? 'bg-danger' : (wr2 < 20 ? 'bg-success' : 'bg-light text-dark')}">
                                WR2: ${wr2.toFixed(1)}
                            </div>
                        </div>
                        <small class="text-muted mt-1" style="font-size: 0.7rem;">
                            ${wr1 > 80 || wr2 > 80 ? '超卖(反弹)' : (wr1 < 20 || wr2 < 20 ? '超买(回调)' : '正常区间')}
                        </small>
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    function generatePredictionHTML(prediction_data, ai_signal, ai_confidence, ai_detailed_probability, ai_pred_1d, ai_pred_3d) {
        let html = '';

        const useAI = ai_detailed_probability &&
                        ai_detailed_probability.up !== undefined &&
                        ai_detailed_probability.down !== undefined &&
                        ai_detailed_probability.sideways !== undefined;

        if (useAI) {
            html += `
                <div class="mb-2">
                    <small class="text-muted">AI交易信号 <span class="badge bg-primary">AI驱动</span></small>
                    <div class="d-flex align-items-center">
                        <span class="badge ${getSignalBadgeClass(ai_signal || '持有')} me-2">${ai_signal || '持有'}</span>
                        <span class="badge bg-info">置信度 ${ai_confidence || 50}%</span>
                    </div>
                </div>

                <div class="mb-2">
                    <small class="text-muted fw-bold">AI 计算的趋势概率</small>
                    <div>
                        <span class="text-success">上涨 ${ai_detailed_probability.up}%</span> |
                        <span class="text-danger">下跌 ${ai_detailed_probability.down}%</span> |
                        <span class="text-secondary">横盘 ${ai_detailed_probability.sideways}%</span>
                    </div>
                </div>

                ${ai_pred_1d ? `
                    <div class="mb-2">
                        <small class="text-muted">AI 1日预测</small>
                        <div class="badge ${ai_pred_1d.trend === '上涨' ? 'bg-success' : (ai_pred_1d.trend === '下跌' ? 'bg-danger' : 'bg-light text-dark')}">
                            ${ai_pred_1d.trend || '预测'}至${ai_pred_1d.target || 'N/A'} (置信度: ${ai_pred_1d.confidence || 50})
                        </div>
                    </div>
                ` : ''}

                ${ai_pred_3d ? `
                    <div class="mb-2">
                        <small class="text-muted">AI 3日预测</small>
                        <div class="badge ${ai_pred_3d.trend === '上涨' ? 'bg-success' : (ai_pred_3d.trend === '下跌' ? 'bg-danger' : 'bg-light text-dark')}">
                            ${ai_pred_3d.trend || '预测'}至${ai_pred_3d.target || 'N/A'} (置信度: ${ai_pred_3d.confidence || 50})
                        </div>
                    </div>
                ` : ''}
            `;
        } else {
            if (!prediction_data || !prediction_data.predictions) {
                return '<span class="text-muted">无预测数据</span>';
            }

            const predictions = prediction_data.predictions;
            const pred_1d = predictions.prediction_1d || {};
            const pred_3d = predictions.prediction_3d || {};
            const trend_probability = prediction_data.trend_probability || {};
            const support_resistance = prediction_data.support_resistance || {support:[], resistance:[]};

            html += `
                <div class="mb-2">
                    <small class="text-muted">AI交易信号 <span class="badge bg-warning">算法计算</span></small>
                    <div class="d-flex align-items-center">
                        <span class="badge ${getSignalBadgeClass(ai_signal || '持有')} me-2">${ai_signal || '持有'}</span>
                        <span class="badge bg-info">置信度 ${ai_confidence || 50}%</span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-6">
                        <small class="text-muted">1日预测</small>
                        <div class="badge ${pred_1d.trend === '上涨' ? 'bg-success' : (pred_1d.trend === '下跌' ? 'bg-danger' : 'bg-light text-dark')}">
                            ${pred_1d.trend || '横盘'}至${pred_1d.target || 'N/A'}
                            (置信度:${pred_1d.confidence || 'low'})
                        </div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">3日预测</small>
                        <div class="badge ${pred_3d.trend === '上涨' ? 'bg-success' : (pred_3d.trend === '下跌' ? 'bg-danger' : 'bg-light text-dark')}">
                            ${pred_3d.trend || '横盘'}至${pred_3d.target || 'N/A'}
                            (置信度:${pred_3d.confidence || 'low'})
                        </div>
                    </div>
                </div>
            `;

            if (support_resistance.resistance && support_resistance.resistance.length > 0) {
                html += `
                    <div class="mt-1 small">
                        <span class="text-muted fw-bold">阻力位:</span>
                        <div class="d-flex flex-wrap gap-1">
                            ${support_resistance.resistance.map(r => `<span class="badge bg-warning text-dark">${r.toFixed(2)}</span>`).join('')}
                        </div>
                    </div>
                `;
            }
        }

        return html;
    }

    function generateAlertHTML(alert_data) {
        if (!alert_data || !alert_data.alerts || alert_data.alerts.length === 0) {
            return '<span class="text-muted">无预警</span>';
        }
        
        const overall_risk = alert_data.overall_risk || 'low';
        const alert_count = alert_data.alert_count || {};
        const alerts = alert_data.alerts || [];
        
        const riskStyles = {
            'high': { badge: 'bg-danger', icon: 'fa-exclamation-circle', text: '高风险' },
            'medium': { badge: 'bg-warning', icon: 'fa-exclamation-triangle', text: '中风险' },
            'low': { badge: 'bg-info', icon: 'fa-info-circle', text: '低风险' }
        };
        
        const riskStyle = riskStyles[overall_risk] || riskStyles['low'];
        
        return `
            <div class="alert ${riskStyle.badge} mb-2">
                <div class="d-flex align-items-center mb-2">
                    <i class="fas ${riskStyle.icon} me-2"></i>
                    <strong>整体风险：${riskStyle.text}</strong>
                </div>
                <div class="small mb-2">
                    预警数量：<span class="badge bg-danger mx-1">${alert_count.high || 0}高风险</span>
                    <span class="badge bg-warning mx-1">${alert_count.medium || 0}中风险</span>
                    <span class="badge bg-info mx-1">${alert_count.low || 0}低风险</span>
                </div>
                ${alerts.length > 0 ? `
                    <div class="small">
                        <strong>关键预警：</strong>
                        <ul class="mb-0 mt-1 ps-3">
                            ${alerts.slice(0, 3).map(alert => `<li>${alert.message}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            </div>
        `;
    }

    // 搜索功能
    document.getElementById('searchInput').addEventListener('input', function() {
        filterHistory();
    });

    // 类型筛选
    document.getElementById('typeFilter').addEventListener('change', function() {
        filterHistory();
    });

    // 筛选历史记录
    function filterHistory() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const typeFilter = document.getElementById('typeFilter').value;
        const historyItems = document.querySelectorAll('.history-item');

        historyItems.forEach(item => {
            const type = item.dataset.type;
            const text = item.textContent.toLowerCase();
            
            const matchesSearch = !searchTerm || text.includes(searchTerm);
            const matchesType = !typeFilter || type === typeFilter;
            
            if (matchesSearch && matchesType) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }

    // 查看历史详情
    function viewHistory(recordId) {
        const modal = new bootstrap.Modal(document.getElementById('historyDetailModal'));
        const content = document.getElementById('historyDetailContent');
        
        // 显示加载状态
        content.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2">正在加载分析详情...</p>
            </div>
        `;
        
        modal.show();
        
        // 从后端获取详细数据
        fetch(`/api/history/${recordId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentHistoryData = data.data;
                    displayHistoryDetail(data.data);
                } else {
                    content.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            加载失败: ${data.error}
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('获取历史详情失败:', error);
                content.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        网络错误，请稍后重试
                    </div>
                `;
            });
    }
    
    // 显示历史详情
    function displayHistoryDetail(data) {
        const content = document.getElementById('historyDetailContent');

        let html = `
            <div class="row mb-3">
                <div class="col-md-6">
                    <h6><i class="fas fa-calendar me-1"></i>分析时间</h6>
                    <p class="text-muted">${formatDateTime(data.created_at)}</p>
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-chart-bar me-1"></i>分析类型</h6>
                    <span class="badge ${getTypeBadgeClass(data.analysis_type)}">
                        ${getTypeDisplayName(data.analysis_type)}
                    </span>
                </div>
            </div>
            <hr>
            <h6><i class="fas fa-list me-1"></i>分析结果 (${data.total_count} 个标的)</h6>
        `;

        if (data.results && data.results.length > 0) {
            html += '<div class="accordion" id="analysisAccordion">';
            
            data.results.forEach((item, index) => {
                const dailyTrendStatus = item.daily_trend_status || '未知状态';
                const aiSignal = item.ai_signal || '持有';
                const aiConfidence = item.ai_confidence || 50;
                const aiComment = item.ai_comment || '暂无AI分析';

                html += `
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                                <div class="d-flex justify-content-between w-100 me-3">
<div>
                                         <strong>${item.name}</strong> (${item.code})
                                         ${item.price ? ` | 当前价: <strong>${item.price}</strong>` : ''}
                                     </div>
                                    <div class="text-end">
                                        <span class="badge me-2 ${(item.涨跌幅 || 0) > 0 ? 'bg-danger text-white' : ((item.涨跌幅 || 0) < 0 ? 'bg-success text-white' : 'bg-warning text-dark')}">
                                            ${(item.涨跌幅 || 0) !== null && (item.涨跌幅 || 0) !== undefined ?
                                                ((item.涨跌幅 || 0) > 0 ? '+' : '') + (item.涨跌幅 || 0).toFixed(2) + '%' :
                                                'N/A'
                                            }
                                        </span>
                                        <span class="badge ${getSignalBadgeClass(aiSignal)} me-2">${aiSignal}</span>
                                        <span class="badge bg-info me-2">置信度 ${aiConfidence}%</span>
                                        <span class="badge ${getTrendBadgeClass(dailyTrendStatus)}">${dailyTrendStatus}</span>
                                    </div>
                                </div>
                            </button>
                        </h2>
                        <div id="collapse${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                             data-bs-parent="#analysisAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>AI投资建议</h6>
<div class="ai-comment mb-3">
                                             ${aiComment.includes('LLM分析服务异常') || aiComment.includes('AI分析服务') ?
                                                 `<span class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>${aiComment}</span>` :
                                                 aiComment
                                             }
                                         </div>
                                         
                                         <!-- 交易建议 -->
                                         <div class="mb-3">
                                             <small class="text-muted">交易建议</small>
                                             <div class="row">
                                                 <div class="col-6">
                                                     <small class="text-muted d-block">当前价格</small>
                                                     <strong>${item.price || '未知'}</strong>
                                                 </div>
                                                 <div class="col-6">
                                                     <small class="text-muted d-block">涨跌概率</small>
                                                     <strong>${item.ai_probability || '未知'}</strong>
                                                 </div>
                                                 <div class="col-6">
                                                     <small class="text-muted d-block">支撑位</small>
                                                     <strong>${item.ai_support || '未知'}</strong>
                                                 </div>
                                                 <div class="col-6">
                                                     <small class="text-muted d-block">阻力位</small>
                                                     <strong>${item.ai_resistance || '未知'}</strong>
                                                 </div>
                                                 <div class="col-6">
                                                     <small class="text-muted d-block">目标价</small>
                                                     <strong class="text-success">${item.ai_target || '未知'}</strong>
                                                 </div>
                                                 <div class="col-6">
                                                     <small class="text-muted d-block">止损价</small>
                                                     <strong class="text-danger">${item.ai_stop_loss || '未知'}</strong>
                                                 </div>
                                             </div>
                                         </div>
                                        
                                        ${item.forward_indicators ? `
                                            <h6 class="mt-3">前瞻性指标</h6>
                                            ${generateForwardIndicatorsHTML(item.forward_indicators)}
                                        ` : ''}
                                        
                                        ${item.prediction_data ? `
                                            <h6 class="mt-3">价格预测</h6>
                                            ${generatePredictionHTML(
                                                item.prediction_data,
                                                item.ai_signal,
                                                item.ai_confidence,
                                                item.ai_detailed_probability,
                                                item.ai_pred_1d,
                                                item.ai_pred_3d,
                                                false
                                            )}
                                        ` : ''}
                                        
                                        ${item.alert_data ? `
                                            <h6 class="mt-3">风险预警</h6>
                                            ${generateAlertHTML(item.alert_data)}
                                        ` : ''}
                                    </div>
                                    <div class="col-md-6">
                                        <h6>技术指标分析</h6>
                                        <div class="technical-analysis mb-3">
                                            ${item.technical_indicators_summary && item.technical_indicators_summary.length > 0 ? 
                                                item.technical_indicators_summary.map(indicator => `<div class="mb-1">• ${indicator}</div>`).join('') : 
                                                '暂无技术分析'
                                            }
                                        </div>
                                        
                                        ${item.analysis_points && item.analysis_points.length > 0 ? `
                                            <h6 class="mt-3">技术信号</h6>
                                            <div class="mt-1 mb-3">
                                                ${item.analysis_points.map(point => 
                                                    `<span class="badge bg-light text-dark me-1 mb-1">${point}</span>`
                                                ).join('')}
                                            </div>
                                        ` : ''}
                                        
                                        <h6 class="mt-3">日线趋势</h6>
                                        <p class="mb-0">
                                            <span class="badge ${getStatusBadgeClass(dailyTrendStatus)}">
                                                ${dailyTrendStatus}
                                            </span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
        } else {
            html += `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-1"></i>
                    暂无分析结果数据
                </div>
            `;
        }
        
        content.innerHTML = html;
    }

    // 下载历史记录
    function downloadHistory(recordId) {
        if (currentHistoryData && currentHistoryData.id === recordId) {
            // 下载当前查看的记录
            downloadCurrentHistory();
        } else {
            // 先获取记录详情，然后下载
            fetch(`/api/history/${recordId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentHistoryData = data.data;
                        downloadCurrentHistory();
                    } else {
                        showAlert(`获取记录详情失败: ${data.error}`, 'danger');
                    }
                })
                .catch(error => {
                    console.error('获取历史详情失败:', error);
                    showAlert('网络错误，请稍后重试', 'danger');
                });
        }
    }
    
    // 下载当前历史记录
    function downloadCurrentHistory() {
        if (!currentHistoryData) {
            showAlert('没有可下载的数据', 'warning');
            return;
        }
        
        try {
            // 准备下载数据
            const downloadData = {
                analysis_type: currentHistoryData.analysis_type,
                created_at: currentHistoryData.created_at,
                total_count: currentHistoryData.total_count,
                results: currentHistoryData.results
            };
            
            // 创建下载链接
            const dataStr = JSON.stringify(downloadData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            // 创建下载链接并触发下载
            const link = document.createElement('a');
            link.href = url;
            link.download = `analysis_${currentHistoryData.analysis_type}_${currentHistoryData.id}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showAlert('下载完成！', 'success');
        } catch (error) {
            console.error('下载失败:', error);
            showAlert('下载失败，请稍后重试', 'danger');
        }
    }

    // 删除历史记录
    function deleteHistory(recordId) {
        if (confirm('确定要删除这条分析记录吗？此操作不可撤销。')) {
            // 调用后端API删除数据
            fetch(`/api/history/${recordId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message, 'success');
                    
                    // 移除DOM元素
                    const historyItem = document.querySelector(`[onclick="viewHistory(${recordId})"]`).closest('.history-item');
                    if (historyItem) {
                        historyItem.remove();
                    }
                } else {
                    showAlert(`删除失败: ${data.error}`, 'danger');
                }
            })
            .catch(error => {
                console.error('删除历史记录失败:', error);
                showAlert('网络错误，请稍后重试', 'danger');
            });
        }
    }

    // 清空所有历史
    function clearHistory() {
        if (confirm('确定要清空所有分析历史吗？此操作不可撤销。')) {
            // 调用后端API清空数据
            fetch('/api/history/clear', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message, 'success');
                    // 清空页面内容
                    document.getElementById('historyList').innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">暂无分析历史</h5>
                            <p class="text-muted">开始您的第一次分析吧！</p>
                        </div>
                    `;
                } else {
                    showAlert(`清空失败: ${data.error}`, 'danger');
                }
            })
            .catch(error => {
                console.error('清空历史记录失败:', error);
                showAlert('网络错误，请稍后重试', 'danger');
            });
        }
    }

    // 刷新历史
    function refreshHistory() {
        showAlert('正在刷新...', 'info');
        location.reload();
    }

    // 下载当前查看的历史
    function downloadCurrentHistory() {
        if (currentHistoryData) {
            const dataStr = JSON.stringify(currentHistoryData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `history_${new Date().getTime()}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            showAlert('历史记录已下载', 'success');
        }
    }

    // 页面加载动画
    document.addEventListener('DOMContentLoaded', function() {
        // 格式化所有时间显示
        const timeDisplays = document.querySelectorAll('.time-display');
        timeDisplays.forEach(span => {
            const timestamp = span.getAttribute('data-timestamp');
            if (timestamp) {
                span.textContent = formatDateTime(timestamp);
            }
        });
        
        const historyItems = document.querySelectorAll('.history-item');
        historyItems.forEach((item, index) => {
            setTimeout(() => {
                item.classList.add('fade-in');
            }, index * 100);
        });
    });
</script>

<!-- 自定义过滤器 -->
<script>
    // 添加自定义Jinja2过滤器的JavaScript实现
    function fromJson(jsonString) {
        try {
            return JSON.parse(jsonString);
        } catch (e) {
            return [];
        }
    }
</script>
{% endblock %}
